<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LifeQuest RPG - Convierte tu vida en una aventura √©pica">
    <title>LifeQuest RPG - Cosmic Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-purple: #9d00ff;
            --neon-green: #00ff88;
            --neon-yellow: #ffff00;
            --neon-red: #ff0040;
            --dark-bg: #0a0a1a;
            --darker-bg: #050510;
            --card-bg: rgba(20, 20, 40, 0.8);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--dark-bg);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* Animated Background */
        .cosmic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(157, 0, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 243, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 40% 40%, rgba(255, 0, 255, 0.1) 0%, transparent 40%),
                var(--dark-bg);
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Neon Effects */
        .neon-text {
            text-shadow: 
                0 0 10px var(--neon-blue),
                0 0 20px var(--neon-blue),
                0 0 40px var(--neon-blue);
        }

        .neon-border {
            box-shadow: 
                0 0 5px var(--neon-blue),
                0 0 10px var(--neon-blue),
                inset 0 0 5px rgba(0, 243, 255, 0.1);
            border: 1px solid var(--neon-blue);
        }

        .neon-border-pink {
            box-shadow: 
                0 0 5px var(--neon-pink),
                0 0 10px var(--neon-pink),
                inset 0 0 5px rgba(255, 0, 255, 0.1);
            border: 1px solid var(--neon-pink);
        }

        /* Glassmorphism Cards */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 243, 255, 0.2);
            border-color: var(--neon-blue);
        }

        /* Buttons */
        .btn-neon {
            background: linear-gradient(45deg, transparent, rgba(0, 243, 255, 0.1));
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-neon:hover {
            background: var(--neon-blue);
            color: var(--dark-bg);
            box-shadow: 
                0 0 20px var(--neon-blue),
                0 0 40px var(--neon-blue);
            transform: scale(1.05);
        }

        .btn-neon::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.5s;
        }

        .btn-neon:hover::before {
            left: 100%;
        }

        .btn-pink {
            border-color: var(--neon-pink);
            color: var(--neon-pink);
            background: linear-gradient(45deg, transparent, rgba(255, 0, 255, 0.1));
        }

        .btn-pink:hover {
            background: var(--neon-pink);
            color: white;
        }

        /* Progress Bars */
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* XP Bar */
        .xp-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            height: 30px;
            overflow: hidden;
            border: 2px solid var(--neon-yellow);
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.3);
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-yellow), #ff8800);
            border-radius: 20px;
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--dark-bg);
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }

        /* Boss Health Bar */
        .boss-health {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid var(--neon-red);
            border-radius: 25px;
            height: 40px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255, 0, 64, 0.3);
        }

        .boss-health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0040, #ff4400);
            border-radius: 25px;
            transition: width 0.5s ease;
            position: relative;
        }

        .boss-health-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 10px,
                rgba(0,0,0,0.1) 10px,
                rgba(0,0,0,0.1) 20px
            );
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px var(--neon-blue); }
            50% { box-shadow: 0 0 40px var(--neon-blue), 0 0 60px var(--neon-purple); }
        }

        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes levelUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); filter: brightness(2); }
            100% { transform: scale(1); }
        }

        .level-up {
            animation: levelUp 1s ease-out;
        }

        /* Particles */
        .particle {
            position: fixed;
            pointer-events: none;
            opacity: 0;
            z-index: 1000;
        }

        @keyframes particleFloat {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(0);
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--card-bg);
            border: 2px solid var(--neon-blue);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--darker-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--neon-blue);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-purple);
        }

        /* Quest Items */
        .quest-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid var(--neon-blue);
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 10px 10px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .quest-item:hover {
            background: rgba(0, 243, 255, 0.1);
            transform: translateX(10px);
        }

        .quest-item.completed {
            opacity: 0.6;
            border-left-color: var(--neon-green);
            text-decoration: line-through;
        }

        /* Achievement Cards */
        .achievement-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.1));
            border: 1px solid gold;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .achievement-card:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        /* Inventory Grid */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            padding: 20px;
        }

        .inventory-item {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--neon-purple);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-item:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--neon-purple);
        }

        .inventory-item.equipped {
            border-color: var(--neon-green);
            box-shadow: 0 0 15px var(--neon-green);
        }

        /* Chat Messages */
        .chat-message {
            background: rgba(0, 243, 255, 0.1);
            border-radius: 15px;
            padding: 10px 15px;
            margin: 5px 0;
            max-width: 80%;
            animation: messageSlide 0.3s ease;
        }

        .chat-message.own {
            background: rgba(255, 0, 255, 0.1);
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .chat-message.other {
            border-bottom-left-radius: 5px;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 2px solid var(--neon-green);
            border-radius: 12px;
            padding: 20px;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            border-color: var(--neon-red);
            box-shadow: 0 10px 30px rgba(255, 0, 64, 0.3);
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 2px solid var(--neon-blue);
            padding: 10px;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px 15px;
            border-radius: 10px;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.1);
        }

        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding-bottom: 80px;
            }
            
            .modal-content {
                margin: 20px;
                max-height: 70vh;
            }
        }

        /* Damage Number Animation */
        .damage-number {
            position: absolute;
            color: var(--neon-red);
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            animation: damageFloat 1s ease-out forwards;
            text-shadow: 0 0 10px var(--neon-red);
        }

        @keyframes damageFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }

        /* Critical Hit Effect */
        .critical-hit {
            animation: criticalShake 0.5s ease;
        }

        @keyframes criticalShake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            20% { transform: translateX(-10px) rotate(-5deg); }
            40% { transform: translateX(10px) rotate(5deg); }
            60% { transform: translateX(-10px) rotate(-3deg); }
            80% { transform: translateX(10px) rotate(3deg); }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(0, 243, 255, 0.1);
            border-top-color: var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 4000;
        }

        @keyframes confettiFall {
            0% { opacity: 1; transform: translateY(-100px) rotate(0deg); }
            100% { opacity: 0; transform: translateY(100vh) rotate(720deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner mb-4"></div>
        <h2 class="font-orbitron text-2xl neon-text">Cargando LifeQuest...</h2>
    </div>

    <!-- Background -->
    <div class="cosmic-bg"></div>
    <div class="stars" id="starsContainer"></div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="font-orbitron text-4xl md:text-6xl font-black mb-2 neon-text float-animation">
                <i class="fas fa-dragon mr-3"></i>LifeQuest RPG
            </h1>
            <p class="text-cyan-300 text-lg">Convierte tu vida en una aventura √©pica</p>
        </header>

        <!-- Player Stats Card -->
        <div class="glass-card p-6 mb-6 pulse-glow">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <div id="avatarDisplay" class="w-20 h-20 rounded-full bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-4xl border-4 border-cyan-400 cursor-pointer hover:scale-110 transition-transform" onclick="app.openAvatarModal()">
                            üßô‚Äç‚ôÇÔ∏è
                        </div>
                        <div id="levelBadge" class="absolute -bottom-2 -right-2 bg-yellow-500 text-black font-bold rounded-full w-8 h-8 flex items-center justify-center border-2 border-white">
                            1
                        </div>
                    </div>
                    <div>
                        <h2 id="playerName" class="font-orbitron text-2xl font-bold text-cyan-300">H√©roe</h2>
                        <p id="playerTitle" class="text-purple-300">Novato</p>
                    </div>
                </div>
                
                <div class="flex-1 w-full max-w-md">
                    <div class="flex justify-between mb-2">
                        <span class="text-yellow-400 font-bold">Nivel <span id="currentLevel">1</span></span>
                        <span class="text-cyan-300"><span id="currentXP">0</span> / <span id="neededXP">100</span> XP</span>
                    </div>
                    <div class="xp-bar">
                        <div id="xpBarFill" class="xp-fill" style="width: 0%">
                            <span id="xpPercentage">0%</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 text-center">
                    <div class="glass-card px-4 py-2">
                        <i class="fas fa-coins text-yellow-400 text-2xl mb-1"></i>
                        <p id="goldAmount" class="font-bold text-xl">0</p>
                        <p class="text-xs text-gray-400">Oro</p>
                    </div>
                    <div class="glass-card px-4 py-2 cursor-pointer hover:bg-red-900/30" onclick="app.openBossModal()">
                        <i class="fas fa-skull text-red-500 text-2xl mb-1 animate-pulse"></i>
                        <p id="bossLevel" class="font-bold text-xl">5</p>
                        <p class="text-xs text-gray-400">Jefe</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Boss Section -->
        <div class="glass-card p-6 mb-6 border-red-500/50">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-orbitron text-xl text-red-400">
                    <i class="fas fa-fire mr-2"></i>Jefe Semanal: Procrastinaci√≥n Suprema
                </h3>
                <span class="text-red-400 font-bold">Nv. <span id="bossDisplayLevel">5</span></span>
            </div>
            <div class="boss-health mb-2">
                <div id="bossHealthBar" class="boss-health-fill" style="width: 75%"></div>
            </div>
            <div class="flex justify-between text-sm text-gray-400 mb-4">
                <span id="bossCurrentHP">750</span>
                <span id="bossMaxHP">1000</span>
            </div>
            <div class="flex flex-wrap gap-2 justify-center">
                <span class="px-3 py-1 bg-yellow-500/20 border border-yellow-500 rounded-full text-yellow-400 text-sm">
                    <i class="fas fa-bolt mr-1"></i>+500 XP
                </span>
                <span class="px-3 py-1 bg-yellow-600/20 border border-yellow-600 rounded-full text-yellow-600 text-sm">
                    <i class="fas fa-coins mr-1"></i>+100 Oro
                </span>
                <span class="px-3 py-1 bg-purple-500/20 border border-purple-500 rounded-full text-purple-400 text-sm">
                    <i class="fas fa-gift mr-1"></i>Cofre √âpico
                </span>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid md:grid-cols-3 gap-6">
            
            <!-- Left Column: Quests -->
            <div class="md:col-span-2 space-y-6">
                
                <!-- Add Quest -->
                <div class="glass-card p-6">
                    <h3 class="font-orbitron text-xl mb-4 text-cyan-300">
                        <i class="fas fa-scroll mr-2"></i>Nueva Misi√≥n
                    </h3>
                    <div class="space-y-4">
                        <input type="text" id="questInput" placeholder="Nombre de la misi√≥n..." 
                            class="w-full bg-black/30 border border-cyan-500/50 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-cyan-400 transition-colors">
                        
                        <div class="flex gap-4">
                            <select id="questCategory" class="flex-1 bg-black/30 border border-cyan-500/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-cyan-400">
                                <option value="strength">üí™ Fuerza</option>
                                <option value="intelligence">üß† Inteligencia</option>
                                <option value="discipline">‚è∞ Disciplina</option>
                                <option value="social">üë• Social</option>
                                <option value="wellness">‚ù§Ô∏è Bienestar</option>
                            </select>
                            
                            <select id="questDifficulty" class="flex-1 bg-black/30 border border-cyan-500/50 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-cyan-400">
                                <option value="easy">üü¢ F√°cil (+20 XP)</option>
                                <option value="medium" selected>üü° Medio (+50 XP)</option>
                                <option value="hard">üî¥ Dif√≠cil (+100 XP)</option>
                                <option value="epic">üü£ √âpico (+200 XP)</option>
                            </select>
                        </div>
                        
                        <button onclick="app.addQuest()" class="btn-neon w-full">
                            <i class="fas fa-plus mr-2"></i>Crear Misi√≥n
                        </button>
                    </div>
                </div>

                <!-- Active Quests -->
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-orbitron text-xl text-cyan-300">
                            <i class="fas fa-tasks mr-2"></i>Misiones Activas
                        </h3>
                        <span id="questCount" class="bg-cyan-500/20 px-3 py-1 rounded-full text-cyan-300 text-sm">0</span>
                    </div>
                    <div id="questList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Quests will be inserted here -->
                    </div>
                </div>

                <!-- Stats -->
                <div class="glass-card p-6">
                    <h3 class="font-orbitron text-xl mb-4 text-cyan-300">
                        <i class="fas fa-chart-bar mr-2"></i>Estad√≠sticas
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-black/20 rounded-lg">
                            <i class="fas fa-check-circle text-green-400 text-2xl mb-2"></i>
                            <p id="completedQuests" class="text-2xl font-bold">0</p>
                            <p class="text-xs text-gray-400">Completadas</p>
                        </div>
                        <div class="text-center p-4 bg-black/20 rounded-lg">
                            <i class="fas fa-fire text-orange-400 text-2xl mb-2"></i>
                            <p id="streakDays" class="text-2xl font-bold">0</p>
                            <p class="text-xs text-gray-400">Racha (d√≠as)</p>
                        </div>
                        <div class="text-center p-4 bg-black/20 rounded-lg">
                            <i class="fas fa-trophy text-yellow-400 text-2xl mb-2"></i>
                            <p id="achievementsUnlocked" class="text-2xl font-bold">0</p>
                            <p class="text-xs text-gray-400">Logros</p>
                        </div>
                        <div class="text-center p-4 bg-black/20 rounded-lg">
                            <i class="fas fa-clock text-blue-400 text-2xl mb-2"></i>
                            <p id="totalPlayTime" class="text-2xl font-bold">0h</p>
                            <p class="text-xs text-gray-400">Tiempo total</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Party & Extras -->
            <div class="space-y-6">
                
                <!-- Party Section -->
                <div class="glass-card p-6">
                    <h3 class="font-orbitron text-xl mb-4 text-purple-300">
                        <i class="fas fa-users mr-2"></i>Party
                    </h3>
                    <div id="partyList" class="space-y-2 mb-4">
                        <div class="flex items-center gap-3 p-2 bg-black/20 rounded-lg">
                            <div class="w-10 h-10 rounded-full bg-cyan-500 flex items-center justify-center">üßô‚Äç‚ôÇÔ∏è</div>
                            <div class="flex-1">
                                <p class="font-bold text-sm">T√∫</p>
                                <p class="text-xs text-green-400">‚óè En l√≠nea</p>
                            </div>
                            <span class="text-xs bg-cyan-500/20 px-2 py-1 rounded">Lv. <span class="party-level">1</span></span>
                        </div>
                    </div>
                    <button onclick="app.openPartyModal()" class="btn-neon w-full text-sm py-2">
                        <i class="fas fa-comments mr-2"></i>Chat de Party
                    </button>
                </div>

                <!-- Achievements Preview -->
                <div class="glass-card p-6">
                    <h3 class="font-orbitron text-xl mb-4 text-yellow-400">
                        <i class="fas fa-medal mr-2"></i>√öltimos Logros
                    </h3>
                    <div id="recentAchievements" class="space-y-2">
                        <p class="text-gray-500 text-center text-sm">A√∫n no has desbloqueado logros</p>
                    </div>
                    <button onclick="app.openAchievementsModal()" class="btn-neon w-full mt-4 text-sm py-2">
                        Ver todos (<span id="totalAchievements">0</span>/161)
                    </button>
                </div>

                <!-- Quick Actions -->
                <div class="glass-card p-6">
                    <h3 class="font-orbitron text-xl mb-4 text-pink-400">
                        <i class="fas fa-bolt mr-2"></i>Acciones R√°pidas
                    </h3>
                    <div class="space-y-2">
                        <button onclick="app.openProfileModal()" class="w-full text-left p-3 rounded-lg bg-black/20 hover:bg-cyan-500/20 transition-colors flex items-center gap-3">
                            <i class="fas fa-user text-cyan-400"></i>
                            <div>
                                <p class="font-bold text-sm">Editar Perfil</p>
                                <p class="text-xs text-gray-400">Cambia tu nombre y email</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-500"></i>
                        </button>
                        
                        <button onclick="app.openAvatarModal()" class="w-full text-left p-3 rounded-lg bg-black/20 hover:bg-purple-500/20 transition-colors flex items-center gap-3">
                            <i class="fas fa-palette text-purple-400"></i>
                            <div>
                                <p class="font-bold text-sm">Personalizar Avatar</p>
                                <p class="text-xs text-gray-400">Cambia tu apariencia</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-500"></i>
                        </button>
                        
                        <button onclick="app.openInventoryModal()" class="w-full text-left p-3 rounded-lg bg-black/20 hover:bg-yellow-500/20 transition-colors flex items-center gap-3">
                            <i class="fas fa-backpack text-yellow-400"></i>
                            <div>
                                <p class="font-bold text-sm">Mi Inventario</p>
                                <p class="text-xs text-gray-400">Ver tus objetos</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-500"></i>
                        </button>
                        
                        <button onclick="app.openShopModal()" class="w-full text-left p-3 rounded-lg bg-black/20 hover:bg-green-500/20 transition-colors flex items-center gap-3">
                            <i class="fas fa-store text-green-400"></i>
                            <div>
                                <p class="font-bold text-sm">Tienda</p>
                                <p class="text-xs text-gray-400">Compra cosm√©ticos</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-500"></i>
                        </button>
                        
                        <button onclick="app.exportData()" class="w-full text-left p-3 rounded-lg bg-black/20 hover:bg-blue-500/20 transition-colors flex items-center gap-3">
                            <i class="fas fa-download text-blue-400"></i>
                            <div>
                                <p class="font-bold text-sm">Exportar Datos</p>
                                <p class="text-xs text-gray-400">Guarda tu progreso</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-500"></i>
                        </button>
                        
                        <button onclick="app.confirmReset()" class="w-full text-left p-3 rounded-lg bg-black/20 hover:bg-red-500/20 transition-colors flex items-center gap-3 text-red-400">
                            <i class="fas fa-trash"></i>
                            <div>
                                <p class="font-bold text-sm">Reiniciar Progreso</p>
                                <p class="text-xs text-red-300">Borra todos tus datos</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav md:hidden">
        <div class="nav-item active" onclick="app.switchTab('quests')">
            <i class="fas fa-scroll"></i>
            <span class="text-xs">Misiones</span>
        </div>
        <div class="nav-item" onclick="app.switchTab('party')">
            <i class="fas fa-users"></i>
            <span class="text-xs">Party</span>
        </div>
        <div class="nav-item" onclick="app.switchTab('shop')">
            <i class="fas fa-store"></i>
            <span class="text-xs">Tienda</span>
        </div>
        <div class="nav-item" onclick="app.switchTab('avatar')">
            <i class="fas fa-user-astronaut"></i>
            <span class="text-xs">Avatar</span>
        </div>
        <div class="nav-item" onclick="app.switchTab('profile')">
            <i class="fas fa-cog"></i>
            <span class="text-xs">Perfil</span>
        </div>
    </nav>

    <!-- Modals -->
    
    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-orbitron text-xl text-cyan-300">Editar Perfil</h3>
                <button onclick="app.closeModal('profileModal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Nombre de H√©roe</label>
                    <input type="text" id="editName" class="w-full bg-black/30 border border-cyan-500/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-cyan-400">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Email</label>
                    <input type="email" id="editEmail" class="w-full bg-black/30 border border-cyan-500/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-cyan-400">
                </div>
                <button onclick="app.saveProfile()" class="btn-neon w-full">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Avatar Modal -->
    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-orbitron text-xl text-purple-300">Personalizar Avatar</h3>
                <button onclick="app.closeModal('avatarModal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="text-center mb-4">
                    <div id="avatarPreview" class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-5xl mb-2 border-4 border-cyan-400">
                        üßô‚Äç‚ôÇÔ∏è
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Emoji del Avatar</label>
                    <div class="grid grid-cols-5 gap-2">
                        <button onclick="app.selectAvatar('üßô‚Äç‚ôÇÔ∏è')" class="p-3 text-2xl bg-black/30 rounded-lg hover:bg-cyan-500/30 transition-colors">üßô‚Äç‚ôÇÔ∏è</button>
                        <button onclick="app.selectAvatar('‚öîÔ∏è')" class="p-3 text-2xl bg-black/30 rounded-lg hover:bg-cyan-500/30 transition-colors">‚öîÔ∏è</button>
                        <button onclick="app.selectAvatar('üõ°Ô∏è')" class="p-3 text-2xl bg-black/30 rounded-lg hover:bg-cyan-500/30 transition-colors">üõ°Ô∏è</button>
                        <button onclick="app.selectAvatar('üèπ')" class="p-3 text-2xl bg-black/30 rounded-lg hover:bg-cyan-500/30 transition-colors">üèπ</button>
                        <button onclick="app.selectAvatar('‚ö°')" class="p-3 text-2xl bg-black/30 rounded-lg hover:bg-cyan-500/30 transition-colors">‚ö°</button>
                        <button onclick="app.selectAvatar('üî•')" class="p-3 text-2xl bg-black/30 rounded-lg hover:bg-cyan-500/30 transition-colors">üî•</button>
                        <button onclick="app.selectAvatar('‚ùÑÔ∏è')" class="p-3 text-2xl bg-black/30 rounded-lg hover:bg-cyan-500/30 transition-colors">‚ùÑÔ∏è</button>
                        <button onclick="app.selectAvatar('üåü')" class="p-3 text-2xl bg-black/30 rounded-lg hover:bg-cyan-500/30 transition-colors">üåü</button>
                        <button onclick="app.selectAvatar('üêâ')" class="p-3 text-2xl bg-black/30 rounded-lg hover:bg-cyan-500/30 transition-colors">üêâ</button>
                        <button onclick="app.selectAvatar('üëë')" class="p-3 text-2xl bg-black/30 rounded-lg hover:bg-cyan-500/30 transition-colors">üëë</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Color de Fondo</label>
                    <div class="flex gap-2">
                        <button onclick="app.selectAvatarColor('from-cyan-500 to-purple-600')" class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-purple-600 border-2 border-white"></button>
                        <button onclick="app.selectAvatarColor('from-red-500 to-orange-600')" class="w-10 h-10 rounded-full bg-gradient-to-br from-red-500 to-orange-600 border-2 border-transparent hover:border-white"></button>
                        <button onclick="app.selectAvatarColor('from-green-500 to-emerald-600')" class="w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 border-2 border-transparent hover:border-white"></button>
                        <button onclick="app.selectAvatarColor('from-yellow-500 to-amber-600')" class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-500 to-amber-600 border-2 border-transparent hover:border-white"></button>
                        <button onclick="app.selectAvatarColor('from-pink-500 to-rose-600')" class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 border-2 border-transparent hover:border-white"></button>
                    </div>
                </div>
                <button onclick="app.saveAvatar()" class="btn-neon w-full">Guardar Avatar</button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-orbitron text-xl text-yellow-400">Mi Inventario</h3>
                <button onclick="app.closeModal('inventoryModal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="inventoryGrid" class="inventory-grid">
                <!-- Items will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shopModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-orbitron text-xl text-green-400">
                    <i class="fas fa-store mr-2"></i>Tienda de Cosm√©ticos
                </h3>
                <div class="flex items-center gap-2 text-yellow-400">
                    <i class="fas fa-coins"></i>
                    <span id="shopGold">0</span>
                </div>
                <button onclick="app.closeModal('shopModal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="shopItems" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                <!-- Shop items will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div id="achievementsModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-orbitron text-xl text-yellow-400">
                    <i class="fas fa-trophy mr-2"></i>Logros
                </h3>
                <button onclick="app.closeModal('achievementsModal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-2">
                    <span>Progreso Total</span>
                    <span id="achievementProgress">0/161</span>
                </div>
                <div class="progress-bar">
                    <div id="achievementBar" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            <div id="achievementsList" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- Achievements will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Boss Modal -->
    <div id="bossModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-orbitron text-xl text-red-400">
                    <i class="fas fa-skull mr-2"></i>Jefe Semanal
                </h3>
                <button onclick="app.closeModal('bossModal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="text-center mb-6">
                <div class="text-6xl mb-4 animate-pulse">üëπ</div>
                <h4 class="text-2xl font-bold text-red-400 mb-2">Procrastinaci√≥n Suprema</h4>
                <p class="text-gray-400">Nivel <span id="modalBossLevel">5</span></p>
            </div>
            <div class="boss-health mb-4">
                <div id="modalBossHealth" class="boss-health-fill" style="width: 75%"></div>
            </div>
            <p class="text-center text-sm text-gray-400 mb-4">
                Completa misiones para da√±ar al jefe. ¬°Derrotarlo otorga grandes recompensas!
            </p>
            <div class="grid grid-cols-3 gap-2 text-center text-sm">
                <div class="p-2 bg-yellow-500/20 rounded">
                    <i class="fas fa-bolt text-yellow-400 block mb-1"></i>
                    +500 XP
                </div>
                <div class="p-2 bg-yellow-600/20 rounded">
                    <i class="fas fa-coins text-yellow-600 block mb-1"></i>
                    +100 Oro
                </div>
                <div class="p-2 bg-purple-500/20 rounded">
                    <i class="fas fa-gift text-purple-400 block mb-1"></i>
                    Cofre √âpico
                </div>
            </div>
        </div>
    </div>

    <!-- Party Chat Modal -->
    <div id="partyModal" class="modal">
        <div class="modal-content max-w-lg h-96 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-orbitron text-xl text-purple-300">
                    <i class="fas fa-comments mr-2"></i>Chat de Party
                </h3>
                <button onclick="app.closeModal('partyModal')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto space-y-2 mb-4 bg-black/20 rounded-lg p-3">
                <div class="chat-message other">
                    <p class="text-xs text-purple-400 mb-1">Sistema</p>
                    <p class="text-sm">¬°Bienvenido al chat de party! Completa misiones para motivar a tus compa√±eros.</p>
                </div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="Escribe un mensaje..." 
                    class="flex-1 bg-black/30 border border-purple-500/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-purple-400"
                    onkeypress="if(event.key==='Enter')app.sendChatMessage()">
                <button onclick="app.sendChatMessage()" class="btn-neon btn-pink px-4">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // ==========================================
        // LifeQuest RPG - Main Application
        // ==========================================
        
        console.log('üéÆ LifeQuest RPG v2.0 - Iniciando carga...');

        // Global error handler
        window.onerror = function(msg, url, line, col, error) {
            console.error('‚ùå Error global:', { msg, url, line, col, error });
            app.showNotification('Error: ' + msg, 'error');
            return false;
        };

        // Sanitization utility
        const sanitize = {
            html: (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            input: (str) => {
                return str.replace(/[<>\"']/g, '');
            }
        };

        // Audio Manager with cleanup
        class AudioManager {
            constructor() {
                this.context = null;
                this.sounds = {};
                this.initialized = false;
            }

            init() {
                if (this.initialized) return;
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    this.initialized = true;
                } catch (e) {
                    console.warn('Audio no soportado:', e);
                }
            }

            playTone(frequency, type = 'sine', duration = 0.1) {
                if (!this.initialized) this.init();
                if (!this.context) return;

                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration);

                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + duration);

                // Cleanup
                setTimeout(() => {
                    oscillator.disconnect();
                    gainNode.disconnect();
                }, duration * 1000 + 100);
            }

            playSuccess() {
                this.playTone(523.25, 'sine', 0.1);
                setTimeout(() => this.playTone(659.25, 'sine', 0.1), 100);
                setTimeout(() => this.playTone(783.99, 'sine', 0.2), 200);
            }

            playLevelUp() {
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 'square', 0.3), i * 150);
                });
            }

            playDamage() {
                this.playTone(150, 'sawtooth', 0.3);
            }

            destroy() {
                if (this.context) {
                    this.context.close();
                    this.context = null;
                }
            }
        }

        // Main App Class
        class LifeQuestApp {
            constructor() {
                this.data = this.loadData();
                this.audio = new AudioManager();
                this.eventListeners = [];
                this.init();
            }

            init() {
                try {
                    this.createStars();
                    this.renderAll();
                    this.setupEventListeners();
                    this.checkDailyReset();
                    this.hideLoading();
                    console.log('‚úÖ LifeQuest RPG cargado exitosamente');
                } catch (error) {
                    console.error('‚ùå Error en inicializaci√≥n:', error);
                    this.showNotification('Error al iniciar la aplicaci√≥n', 'error');
                }
            }

            // Safe localStorage operations
            loadData() {
                const defaultData = {
                    player: {
                        name: 'H√©roe',
                        email: 'jugador@lifequest.com',
                        level: 1,
                        xp: 0,
                        gold: 0,
                        avatar: 'üßô‚Äç‚ôÇÔ∏è',
                        avatarColor: 'from-cyan-500 to-purple-600',
                        title: 'Novato'
                    },
                    quests: [],
                    completedQuests: 0,
                    achievements: [],
                    inventory: [],
                    boss: {
                        level: 5,
                        currentHP: 750,
                        maxHP: 1000
                    },
                    stats: {
                        streakDays: 0,
                        lastActive: new Date().toISOString(),
                        totalPlayTime: 0,
                        categories: {
                            strength: 0,
                            intelligence: 0,
                            discipline: 0,
                            social: 0,
                            wellness: 0
                        }
                    },
                    settings: {
                        soundEnabled: true,
                        notifications: true
                    }
                };

                try {
                    const saved = localStorage.getItem('lifequest_data');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        // Merge with defaults to ensure all fields exist
                        return this.deepMerge(defaultData, parsed);
                    }
                } catch (e) {
                    console.error('Error cargando datos:', e);
                    this.showNotification('Error al cargar datos guardados', 'error');
                }
                
                return defaultData;
            }

            saveData() {
                try {
                    localStorage.setItem('lifequest_data', JSON.stringify(this.data));
                    return true;
                } catch (e) {
                    console.error('Error guardando datos:', e);
                    this.showNotification('Error al guardar datos', 'error');
                    return false;
                }
            }

            deepMerge(target, source) {
                const output = Object.assign({}, target);
                if (this.isObject(target) && this.isObject(source)) {
                    Object.keys(source).forEach(key => {
                        if (this.isObject(source[key])) {
                            if (!(key in target)) {
                                Object.assign(output, { [key]: source[key] });
                            } else {
                                output[key] = this.deepMerge(target[key], source[key]);
                            }
                        } else {
                            Object.assign(output, { [key]: source[key] });
                        }
                    });
                }
                return output;
            }

            isObject(item) {
                return (item && typeof item === 'object' && !Array.isArray(item));
            }

            // ID Generation using crypto.randomUUID with fallback
            generateId() {
                if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // Event Listener Management with cleanup
            setupEventListeners() {
                // Cleanup previous listeners
                this.cleanupEventListeners();

                // Auto-save on page hide
                const saveHandler = () => this.saveData();
                window.addEventListener('beforeunload', saveHandler);
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) this.saveData();
                });

                this.eventListeners.push(
                    { element: window, event: 'beforeunload', handler: saveHandler },
                    { element: document, event: 'visibilitychange', handler: saveHandler }
                );
            }

            cleanupEventListeners() {
                this.eventListeners.forEach(({ element, event, handler }) => {
                    element.removeEventListener(event, handler);
                });
                this.eventListeners = [];
            }

            // UI Rendering
            renderAll() {
                this.renderPlayerStats();
                this.renderQuests();
                this.renderBoss();
                this.renderAchievements();
                this.renderInventory();
                this.updateStats();
            }

            renderPlayerStats() {
                const p = this.data.player;
                document.getElementById('playerName').textContent = sanitize.html(p.name);
                document.getElementById('playerTitle').textContent = sanitize.html(p.title);
                document.getElementById('currentLevel').textContent = p.level;
                document.getElementById('levelBadge').textContent = p.level;
                document.getElementById('currentXP').textContent = p.xp;
                
                const neededXP = this.getXPForLevel(p.level);
                document.getElementById('neededXP').textContent = neededXP;
                
                const percentage = Math.min((p.xp / neededXP) * 100, 100);
                document.getElementById('xpBarFill').style.width = percentage + '%';
                document.getElementById('xpPercentage').textContent = Math.floor(percentage) + '%';
                
                document.getElementById('goldAmount').textContent = p.gold;
                document.getElementById('avatarDisplay').textContent = p.avatar;
                document.getElementById('avatarDisplay').className = 
                    `w-20 h-20 rounded-full bg-gradient-to-br ${p.avatarColor} flex items-center justify-center text-4xl border-4 border-cyan-400 cursor-pointer hover:scale-110 transition-transform`;
                
                // Update party level
                document.querySelectorAll('.party-level').forEach(el => el.textContent = p.level);
            }

            renderQuests() {
                const list = document.getElementById('questList');
                const quests = this.data.quests || [];
                
                document.getElementById('questCount').textContent = quests.length;
                
                if (quests.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-scroll text-4xl mb-3 opacity-50"></i>
                            <p>No hay misiones activas</p>
                            <p class="text-sm mt-2">¬°Crea tu primera misi√≥n arriba!</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = quests.map(quest => `
                    <div class="quest-item ${quest.completed ? 'completed' : ''}" data-id="${quest.id}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1" onclick="app.toggleQuest('${quest.id}')">
                                <h4 class="font-bold ${quest.completed ? 'line-through text-gray-500' : 'text-cyan-300'}">
                                    ${sanitize.html(quest.name)}
                                </h4>
                                <div class="flex gap-2 mt-2 text-xs">
                                    <span class="px-2 py-1 rounded bg-black/30 ${this.getCategoryColor(quest.category)}">
                                        ${this.getCategoryIcon(quest.category)} ${this.getCategoryName(quest.category)}
                                    </span>
                                    <span class="px-2 py-1 rounded bg-black/30 text-gray-400">
                                        ${this.getDifficultyLabel(quest.difficulty)}
                                    </span>
                                    <span class="px-2 py-1 rounded bg-black/30 text-yellow-400">
                                        +${this.getXPReward(quest.difficulty)} XP
                                    </span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); app.completeQuest('${quest.id}')" 
                                    class="p-2 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/40 transition-colors ${quest.completed ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${quest.completed ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="event.stopPropagation(); app.deleteQuest('${quest.id}')" 
                                    class="p-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/40 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            renderBoss() {
                const boss = this.data.boss;
                const percentage = (boss.currentHP / boss.maxHP) * 100;
                
                document.getElementById('bossLevel').textContent = boss.level;
                document.getElementById('bossDisplayLevel').textContent = boss.level;
                document.getElementById('modalBossLevel').textContent = boss.level;
                document.getElementById('bossCurrentHP').textContent = boss.currentHP;
                document.getElementById('bossMaxHP').textContent = boss.maxHP;
                
                document.getElementById('bossHealthBar').style.width = percentage + '%';
                document.getElementById('modalBossHealth').style.width = percentage + '%';
            }

            renderAchievements() {
                const achievements = this.getAllAchievements();
                const unlocked = this.data.achievements || [];
                const recent = achievements.filter(a => unlocked.includes(a.id)).slice(-3);
                
                document.getElementById('totalAchievements').textContent = unlocked.length;
                document.getElementById('achievementsUnlocked').textContent = unlocked.length;
                
                const recentContainer = document.getElementById('recentAchievements');
                if (recent.length === 0) {
                    recentContainer.innerHTML = '<p class="text-gray-500 text-center text-sm">A√∫n no has desbloqueado logros</p>';
                } else {
                    recentContainer.innerHTML = recent.map(a => `
                        <div class="achievement-card text-sm">
                            <div class="text-2xl">${a.icon}</div>
                            <div>
                                <p class="font-bold text-yellow-400">${sanitize.html(a.name)}</p>
                                <p class="text-xs text-gray-400">${sanitize.html(a.description)}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Update progress bar
                const progress = (unlocked.length / 161) * 100;
                document.getElementById('achievementProgress').textContent = `${unlocked.length}/161`;
                document.getElementById('achievementBar').style.width = progress + '%';
            }

            renderInventory() {
                const grid = document.getElementById('inventoryGrid');
                const items = this.data.inventory || [];
                
                if (items.length === 0) {
                    grid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">Tu inventario est√° vac√≠o</p>';
                    return;
                }

                grid.innerHTML = items.map(item => `
                    <div class="inventory-item ${item.equipped ? 'equipped' : ''}" 
                         onclick="app.toggleEquipItem('${item.id}')"
                         title="${sanitize.html(item.name)}">
                        ${item.icon}
                        ${item.equipped ? '<div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center text-xs">‚úì</div>' : ''}
                    </div>
                `).join('');
            }

            updateStats() {
                document.getElementById('completedQuests').textContent = this.data.completedQuests || 0;
                document.getElementById('streakDays').textContent = this.data.stats.streakDays || 0;
                
                const playTime = Math.floor((this.data.stats.totalPlayTime || 0) / 3600);
                document.getElementById('totalPlayTime').textContent = playTime + 'h';
            }

            // Quest Management
            addQuest() {
                const nameInput = document.getElementById('questInput');
                const categorySelect = document.getElementById('questCategory');
                const difficultySelect = document.getElementById('questDifficulty');
                
                const name = sanitize.input(nameInput.value.trim());
                if (!name) {
                    this.showNotification('Ingresa un nombre para la misi√≥n', 'error');
                    return;
                }

                const quest = {
                    id: this.generateId(),
                    name: name,
                    category: categorySelect.value,
                    difficulty: difficultySelect.value,
                    completed: false,
                    createdAt: new Date().toISOString()
                };

                this.data.quests.push(quest);
                this.saveData();
                this.renderQuests();
                
                nameInput.value = '';
                this.showNotification('¬°Misi√≥n creada!', 'success');
                this.createParticles(event.target, '‚ú®');
            }

            toggleQuest(id) {
                const quest = this.data.quests.find(q => q.id === id);
                if (quest) {
                    quest.completed = !quest.completed;
                    this.saveData();
                    this.renderQuests();
                }
            }

            completeQuest(id) {
                const questIndex = this.data.quests.findIndex(q => q.id === id);
                if (questIndex === -1) return;
                
                const quest = this.data.quests[questIndex];
                if (quest.completed) return;

                // Mark as completed
                quest.completed = true;
                this.data.completedQuests++;
                
                // Calculate rewards
                const xpReward = this.getXPReward(quest.difficulty);
                const goldReward = this.getGoldReward(quest.difficulty);
                
                // Apply rewards
                this.addXP(xpReward);
                this.addGold(goldReward);
                
                // Damage boss
                const damage = this.getBossDamage(quest.difficulty);
                this.damageBoss(damage);
                
                // Update category stats
                this.data.stats.categories[quest.category]++;
                
                // Remove from active quests
                this.data.quests.splice(questIndex, 1);
                
                // Check achievements
                this.checkAchievements();
                
                this.saveData();
                this.renderAll();
                
                // Effects
                this.audio.playSuccess();
                this.showNotification(`¬°+${xpReward} XP! +${goldReward} Oro`, 'success');
                this.createConfetti();
                
                // Check for boss defeat
                if (this.data.boss.currentHP <= 0) {
                    this.defeatBoss();
                }
            }

            deleteQuest(id) {
                if (!confirm('¬øEliminar esta misi√≥n?')) return;
                
                this.data.quests = this.data.quests.filter(q => q.id !== id);
                this.saveData();
                this.renderQuests();
                this.showNotification('Misi√≥n eliminada', 'success');
            }

            // Boss System
            damageBoss(amount) {
                this.data.boss.currentHP = Math.max(0, this.data.boss.currentHP - amount);
                this.renderBoss();
                
                // Visual feedback
                const bossBar = document.getElementById('bossHealthBar');
                bossBar.parentElement.classList.add('critical-hit');
                setTimeout(() => bossBar.parentElement.classList.remove('critical-hit'), 500);
                
                // Damage number
                this.showDamageNumber(amount);
            }

            showDamageNumber(damage) {
                const container = document.querySelector('.boss-health');
                const num = document.createElement('div');
                num.className = 'damage-number';
                num.textContent = '-' + damage;
                num.style.left = Math.random() * 80 + 10 + '%';
                num.style.top = '50%';
                container.appendChild(num);
                
                setTimeout(() => num.remove(), 1000);
            }

            defeatBoss() {
                this.audio.playLevelUp();
                
                // Rewards
                this.addXP(500);
                this.addGold(100);
                
                // Level up boss
                this.data.boss.level++;
                this.data.boss.maxHP = 1000 + (this.data.boss.level * 200);
                this.data.boss.currentHP = this.data.boss.maxHP;
                
                this.showNotification('¬°JEFE DERROTADO! +500 XP +100 Oro', 'success');
                this.createConfetti();
                
                // Add epic chest to inventory
                this.addToInventory({
                    id: this.generateId(),
                    name: 'Cofre √âpico',
                    icon: 'üéÅ',
                    type: 'chest',
                    rarity: 'epic'
                });
            }

            // XP and Level System
            addXP(amount) {
                this.data.player.xp += amount;
                const needed = this.getXPForLevel(this.data.player.level);
                
                if (this.data.player.xp >= needed) {
                    this.levelUp();
                }
            }

            levelUp() {
                this.data.player.level++;
                this.data.player.xp = 0;
                this.data.player.title = this.getTitleForLevel(this.data.player.level);
                
                this.audio.playLevelUp();
                this.showNotification(`¬°SUBISTE DE NIVEL ${this.data.player.level}!`, 'success');
                
                const badge = document.getElementById('levelBadge');
                badge.classList.add('level-up');
                setTimeout(() => badge.classList.remove('level-up'), 1000);
                
                this.createConfetti();
            }

            addGold(amount) {
                this.data.player.gold += amount;
                this.renderPlayerStats();
                
                // Update shop gold display if open
                const shopGold = document.getElementById('shopGold');
                if (shopGold) shopGold.textContent = this.data.player.gold;
            }

            // Achievement System (161 achievements)
            getAllAchievements() {
                const achievements = [
                    // Level achievements (20)
                    ...Array.from({ length: 20 }, (_, i) => ({
                        id: `level_${i + 1}`,
                        name: `Nivel ${i + 1}`,
                        description: `Alcanza el nivel ${i + 1}`,
                        icon: '‚≠ê',
                        condition: () => this.data.player.level >= i + 1
                    })),
                    
                    // Quest achievements (50)
                    ...Array.from({ length: 50 }, (_, i) => ({
                        id: `quests_${(i + 1) * 10}`,
                        name: `Cazador de Misiones ${(i + 1) * 10}`,
                        description: `Completa ${(i + 1) * 10} misiones`,
                        icon: 'üìú',
                        condition: () => this.data.completedQuests >= (i + 1) * 10
                    })),
                    
                    // Gold achievements (20)
                    ...Array.from({ length: 20 }, (_, i) => ({
                        id: `gold_${(i + 1) * 100}`,
                        name: `Tesoro ${(i + 1) * 100}`,
                        description: `Acumula ${(i + 1) * 100} de oro`,
                        icon: 'üí∞',
                        condition: () => this.data.player.gold >= (i + 1) * 100
                    })),
                    
                    // Boss achievements (20)
                    ...Array.from({ length: 20 }, (_, i) => ({
                        id: `boss_${i + 1}`,
                        name: `Cazador de Jefes ${i + 1}`,
                        description: `Derrota ${i + 1} jefes semanales`,
                        icon: 'üëπ',
                        condition: () => this.data.boss.level > 5 + i
                    })),
                    
                    // Streak achievements (20)
                    ...Array.from({ length: 20 }, (_, i) => ({
                        id: `streak_${i + 1}`,
                        name: `Racha de ${i + 1} d√≠as`,
                        description: `Mant√©n una racha de ${i + 1} d√≠as`,
                        icon: 'üî•',
                        condition: () => this.data.stats.streakDays >= i + 1
                    })),
                    
                    // Category achievements (25)
                    ...['strength', 'intelligence', 'discipline', 'social', 'wellness'].flatMap((cat, idx) => 
                        Array.from({ length: 5 }, (_, i) => ({
                            id: `${cat}_${(i + 1) * 10}`,
                            name: `${this.getCategoryName(cat)} Maestro ${(i + 1) * 10}`,
                            description: `Completa ${(i + 1) * 10} misiones de ${this.getCategoryName(cat)}`,
                            icon: this.getCategoryIcon(cat),
                            condition: () => (this.data.stats.categories[cat] || 0) >= (i + 1) * 10
                        }))
                    ),
                    
                    // Special achievements (6)
                    {
                        id: 'first_quest',
                        name: 'Primeros Pasos',
                        description: 'Completa tu primera misi√≥n',
                        icon: 'üë£',
                        condition: () => this.data.completedQuests >= 1
                    },
                    {
                        id: 'rich',
                        name: 'Millonario',
                        description: 'Acumula 1000 de oro',
                        icon: 'üíé',
                        condition: () => this.data.player.gold >= 1000
                    },
                    {
                        id: 'legend',
                        name: 'Leyenda',
                        description: 'Alcanza el nivel 50',
                        icon: 'üëë',
                        condition: () => this.data.player.level >= 50
                    },
                    {
                        id: 'dedicated',
                        name: 'Dedicado',
                        description: 'Juega durante 100 horas',
                        icon: '‚è∞',
                        condition: () => (this.data.stats.totalPlayTime || 0) >= 360000
                    },
                    {
                        id: 'collector',
                        name: 'Coleccionista',
                        description: 'Desbloquea 50 logros',
                        icon: 'üèÜ',
                        condition: () => (this.data.achievements || []).length >= 50
                    },
                    {
                        id: 'master',
                        name: 'Maestro del Tiempo',
                        description: 'Derrota al jefe nivel 25',
                        icon: '‚öîÔ∏è',
                        condition: () => this.data.boss.level >= 25
                    }
                ];
                
                return achievements;
            }

            checkAchievements() {
                const all = this.getAllAchievements();
                const unlocked = this.data.achievements || [];
                let newUnlocks = false;
                
                all.forEach(achievement => {
                    if (!unlocked.includes(achievement.id) && achievement.condition()) {
                        unlocked.push(achievement.id);
                        newUnlocks = true;
                        this.showNotification(`¬°Logro desbloqueado: ${achievement.name}!`, 'success');
                    }
                });
                
                if (newUnlocks) {
                    this.data.achievements = unlocked;
                    this.saveData();
                    this.renderAchievements();
                }
            }

            // Shop System
            getShopItems() {
                return [
                    { id: 'avatar_warrior', name: 'Guerrero', icon: '‚öîÔ∏è', price: 100, type: 'avatar' },
                    { id: 'avatar_mage', name: 'Mago', icon: 'üîÆ', price: 100, type: 'avatar' },
                    { id: 'avatar_archer', name: 'Arquero', icon: 'üèπ', price: 150, type: 'avatar' },
                    { id: 'avatar_paladin', name: 'Palad√≠n', icon: 'üõ°Ô∏è', price: 200, type: 'avatar' },
                    { id: 'color_gold', name: 'Dorado', color: 'from-yellow-400 to-orange-500', price: 300, type: 'color' },
                    { id: 'color_ice', name: 'Helado', color: 'from-blue-300 to-cyan-500', price: 250, type: 'color' },
                    { id: 'color_nature', name: 'Natural', color: 'from-green-400 to-emerald-600', price: 250, type: 'color' },
                    { id: 'title_knight', name: 'T√≠tulo: Caballero', price: 500, type: 'title', value: 'Caballero' },
                    { id: 'title_king', name: 'T√≠tulo: Rey', price: 1000, type: 'title', value: 'Rey' },
                    { id: 'title_god', name: 'T√≠tulo: Dios', price: 5000, type: 'title', value: 'Dios' }
                ];
            }

            openShopModal() {
                const items = this.getShopItems();
                const container = document.getElementById('shopItems');
                document.getElementById('shopGold').textContent = this.data.player.gold;
                
                container.innerHTML = items.map(item => {
                    const canAfford = this.data.player.gold >= item.price;
                    const owned = this.data.inventory.some(i => i.shopId === item.id);
                    
                    return `
                        <div class="glass-card p-4 flex items-center justify-between ${!canAfford ? 'opacity-60' : ''}">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">${item.icon || '‚ú®'}</div>
                                <div>
                                    <p class="font-bold text-cyan-300">${sanitize.html(item.name)}</p>
                                    <p class="text-sm text-gray-400">${item.type === 'avatar' ? 'Avatar' : item.type === 'color' ? 'Color' : 'T√≠tulo'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-yellow-400 font-bold mb-2">
                                    <i class="fas fa-coins mr-1"></i>${item.price}
                                </p>
                                ${owned ? 
                                    '<span class="text-green-400 text-sm">‚úì Comprado</span>' :
                                    `<button onclick="app.buyItem('${item.id}')" 
                                        class="btn-neon text-sm py-1 px-3 ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${!canAfford ? 'disabled' : ''}>
                                        Comprar
                                    </button>`
                                }
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.openModal('shopModal');
            }

            buyItem(itemId) {
                const item = this.getShopItems().find(i => i.id === itemId);
                if (!item || this.data.player.gold < item.price) {
                    this.showNotification('No tienes suficiente oro', 'error');
                    return;
                }

                this.data.player.gold -= item.price;
                
                // Apply item based on type
                if (item.type === 'avatar') {
                    this.data.player.avatar = item.icon;
                } else if (item.type === 'color') {
                    this.data.player.avatarColor = item.color;
                } else if (item.type === 'title') {
                    this.data.player.title = item.value;
                }

                // Add to inventory
                this.addToInventory({
                    id: this.generateId(),
                    shopId: item.id,
                    name: item.name,
                    icon: item.icon || 'üéÅ',
                    type: item.type,
                    equipped: true
                });

                this.saveData();
                this.renderAll();
                this.openShopModal(); // Refresh shop
                this.showNotification(`¬°Comprado: ${item.name}!`, 'success');
                this.audio.playSuccess();
            }

            addToInventory(item) {
                if (!this.data.inventory) this.data.inventory = [];
                this.data.inventory.push(item);
            }

            toggleEquipItem(itemId) {
                const item = this.data.inventory.find(i => i.id === itemId);
                if (!item) return;

                // Unequip others of same type
                this.data.inventory.forEach(i => {
                    if (i.type === item.type && i.id !== itemId) {
                        i.equipped = false;
                    }
                });

                item.equipped = !item.equipped;
                
                // Apply effects
                if (item.equipped) {
                    if (item.type === 'avatar') this.data.player.avatar = item.icon;
                    if (item.type === 'color') this.data.player.avatarColor = item.color;
                }

                this.saveData();
                this.renderInventory();
                this.renderPlayerStats();
            }

            // Chat System
            sendChatMessage() {
                const input = document.getElementById('chatInput');
                const message = sanitize.input(input.value.trim());
                
                if (!message) return;

                const container = document.getElementById('chatMessages');
                const msgDiv = document.createElement('div');
                msgDiv.className = 'chat-message own';
                msgDiv.innerHTML = `
                    <p class="text-xs text-pink-400 mb-1">${sanitize.html(this.data.player.name)}</p>
                    <p class="text-sm">${sanitize.html(message)}</p>
                `;
                container.appendChild(msgDiv);
                container.scrollTop = container.scrollHeight;
                
                input.value = '';

                // Simulate party member response
                setTimeout(() => {
                    const responses = [
                        '¬°Gran trabajo! üí™',
                        '¬°Sigue as√≠! üî•',
                        '¬°Eres una inspiraci√≥n! ‚≠ê',
                        '¬°Vamos por ese jefe! üëπ',
                        '¬°Incre√≠ble progreso! üéâ'
                    ];
                    const response = responses[Math.floor(Math.random() * responses.length)];
                    
                    const replyDiv = document.createElement('div');
                    replyDiv.className = 'chat-message other';
                    replyDiv.innerHTML = `
                        <p class="text-xs text-cyan-400 mb-1">Compa√±ero de Party</p>
                        <p class="text-sm">${response}</p>
                    `;
                    container.appendChild(replyDiv);
                    container.scrollTop = container.scrollHeight;
                }, 1500);
            }

            // Utility Methods
            getXPForLevel(level) {
                return Math.floor(100 * Math.pow(1.5, level - 1));
            }

            getTitleForLevel(level) {
                const titles = ['Novato', 'Aprendiz', 'Aventurero', 'Guerrero', 'Caballero', 
                               'Campe√≥n', 'H√©roe', 'Leyenda', 'Semidi√≥s', 'Dios'];
                return titles[Math.min(Math.floor(level / 5), titles.length - 1)] || 'Novato';
            }

            getXPReward(difficulty) {
                const rewards = { easy: 20, medium: 50, hard: 100, epic: 200 };
                return rewards[difficulty] || 50;
            }

            getGoldReward(difficulty) {
                const rewards = { easy: 5, medium: 10, hard: 25, epic: 50 };
                return rewards[difficulty] || 10;
            }

            getBossDamage(difficulty) {
                const damage = { easy: 25, medium: 50, hard: 100, epic: 200 };
                return damage[difficulty] || 50;
            }

            getCategoryName(cat) {
                const names = {
                    strength: 'Fuerza',
                    intelligence: 'Inteligencia',
                    discipline: 'Disciplina',
                    social: 'Social',
                    wellness: 'Bienestar'
                };
                return names[cat] || cat;
            }

            getCategoryIcon(cat) {
                const icons = {
                    strength: 'üí™',
                    intelligence: 'üß†',
                    discipline: '‚è∞',
                    social: 'üë•',
                    wellness: '‚ù§Ô∏è'
                };
                return icons[cat] || '‚≠ê';
            }

            getCategoryColor(cat) {
                const colors = {
                    strength: 'text-red-400 border-red-400',
                    intelligence: 'text-blue-400 border-blue-400',
                    discipline: 'text-purple-400 border-purple-400',
                    social: 'text-green-400 border-green-400',
                    wellness: 'text-pink-400 border-pink-400'
                };
                return colors[cat] || 'text-cyan-400';
            }

            getDifficultyLabel(diff) {
                const labels = {
                    easy: 'üü¢ F√°cil',
                    medium: 'üü° Medio',
                    hard: 'üî¥ Dif√≠cil',
                    epic: 'üü£ √âpico'
                };
                return labels[diff] || diff;
            }

            // Modal Management
            openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
                document.body.style.overflow = '';
            }

            openProfileModal() {
                document.getElementById('editName').value = this.data.player.name;
                document.getElementById('editEmail').value = this.data.player.email;
                this.openModal('profileModal');
            }

            saveProfile() {
                const name = sanitize.input(document.getElementById('editName').value.trim());
                const email = sanitize.input(document.getElementById('editEmail').value.trim());
                
                if (name) this.data.player.name = name;
                if (email) this.data.player.email = email;
                
                this.saveData();
                this.renderPlayerStats();
                this.closeModal('profileModal');
                this.showNotification('Perfil actualizado', 'success');
            }

            openAvatarModal() {
                document.getElementById('avatarPreview').textContent = this.data.player.avatar;
                this.openModal('avatarModal');
            }

            selectAvatar(emoji) {
                this.tempAvatar = emoji;
                document.getElementById('avatarPreview').textContent = emoji;
            }

            selectAvatarColor(colorClass) {
                this.tempAvatarColor = colorClass;
                document.getElementById('avatarPreview').className = 
                    `w-24 h-24 mx-auto rounded-full bg-gradient-to-br ${colorClass} flex items-center justify-center text-5xl mb-2 border-4 border-cyan-400`;
            }

            saveAvatar() {
                if (this.tempAvatar) this.data.player.avatar = this.tempAvatar;
                if (this.tempAvatarColor) this.data.player.avatarColor = this.tempAvatarColor;
                
                this.saveData();
                this.renderPlayerStats();
                this.closeModal('avatarModal');
                this.showNotification('Avatar actualizado', 'success');
            }

            openInventoryModal() {
                this.renderInventory();
                this.openModal('inventoryModal');
            }

            openAchievementsModal() {
                const list = document.getElementById('achievementsList');
                const all = this.getAllAchievements();
                const unlocked = this.data.achievements || [];
                
                list.innerHTML = all.map(a => {
                    const isUnlocked = unlocked.includes(a.id);
                    return `
                        <div class="achievement-card ${isUnlocked ? '' : 'locked'}">
                            <div class="text-3xl">${isUnlocked ? a.icon : 'üîí'}</div>
                            <div class="flex-1">
                                <p class="font-bold ${isUnlocked ? 'text-yellow-400' : 'text-gray-500'}">${sanitize.html(a.name)}</p>
                                <p class="text-sm text-gray-400">${sanitize.html(a.description)}</p>
                            </div>
                            ${isUnlocked ? '<i class="fas fa-check-circle text-green-400 text-xl"></i>' : ''}
                        </div>
                    `;
                }).join('');
                
                this.openModal('achievementsModal');
            }

            openBossModal() {
                this.openModal('bossModal');
            }

            openPartyModal() {
                this.openModal('partyModal');
            }

            // Data Export/Import
            exportData() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `lifequest_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                this.showNotification('Datos exportados', 'success');
            }

            importData(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        this.data = this.deepMerge(this.data, imported);
                        this.saveData();
                        this.renderAll();
                        this.showNotification('Datos importados correctamente', 'success');
                    } catch (err) {
                        this.showNotification('Error al importar datos', 'error');
                    }
                };
                reader.readAsText(file);
            }

            confirmReset() {
                if (confirm('¬øEST√ÅS SEGURO? Esto borrar√° TODO tu progreso permanentemente.')) {
                    if (confirm('√öltima advertencia: ¬øRealmente quieres empezar desde cero?')) {
                        localStorage.removeItem('lifequest_data');
                        location.reload();
                    }
                }
            }

            // Visual Effects
            createStars() {
                const container = document.getElementById('starsContainer');
                for (let i = 0; i < 100; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.width = Math.random() * 3 + 'px';
                    star.style.height = star.style.width;
                    star.style.animationDelay = Math.random() * 3 + 's';
                    container.appendChild(star);
                }
            }

            createParticles(element, emoji) {
                const rect = element.getBoundingClientRect();
                for (let i = 0; i < 5; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.textContent = emoji;
                    particle.style.left = rect.left + rect.width / 2 + 'px';
                    particle.style.top = rect.top + 'px';
                    particle.style.fontSize = '20px';
                    particle.style.setProperty('--tx', (Math.random() - 0.5) * 100 + 'px');
                    particle.style.setProperty('--ty', (Math.random() - 1) * 100 + 'px');
                    particle.style.animation = 'particleFloat 1s ease-out forwards';
                    
                    document.body.appendChild(particle);
                    setTimeout(() => particle.remove(), 1000);
                }
            }

            createConfetti() {
                const colors = ['#00f3ff', '#ff00ff', '#00ff88', '#ffff00', '#ff0040'];
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animation = `confettiFall ${Math.random() * 2 + 2}s linear forwards`;
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 4000);
                }
            }

            // Notification System
            showNotification(message, type = 'success') {
                const container = document.getElementById('notificationContainer');
                const notif = document.createElement('div');
                notif.className = `notification ${type}`;
                
                const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                const color = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : 'text-blue-400';
                
                notif.innerHTML = `
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">${icon}</span>
                        <div class="flex-1">
                            <p class="font-bold ${color} mb-1">${type === 'success' ? '¬°√âxito!' : type === 'error' ? 'Error' : 'Info'}</p>
                            <p class="text-sm text-gray-300">${sanitize.html(message)}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-white">&times;</button>
                    </div>
                `;
                
                container.appendChild(notif);
                
                // Trigger animation
                requestAnimationFrame(() => {
                    notif.classList.add('show');
                });
                
                // Auto remove
                setTimeout(() => {
                    notif.classList.remove('show');
                    setTimeout(() => notif.remove(), 300);
                }, 3000);
            }

            // Daily Reset System
            checkDailyReset() {
                const lastActive = new Date(this.data.stats.lastActive);
                const now = new Date();
                const lastReset = new Date(lastActive);
                lastReset.setHours(5, 0, 0, 0);
                
                const currentReset = new Date(now);
                currentReset.setHours(5, 0, 0, 0);
                
                if (now > currentReset && lastActive < currentReset) {
                    // It's a new day after 5 AM
                    this.performDailyReset();
                }
                
                // Update streak
                const daysDiff = Math.floor((now - lastActive) / (1000 * 60 * 60 * 24));
                if (daysDiff === 1) {
                    this.data.stats.streakDays++;
                    this.showNotification(`¬°Racha de ${this.data.stats.streakDays} d√≠as! üî•`, 'success');
                } else if (daysDiff > 1) {
                    this.data.stats.streakDays = 0;
                }
                
                this.data.stats.lastActive = now.toISOString();
                this.saveData();
            }

            performDailyReset() {
                // Reset daily quests if any
                this.showNotification('üåÖ Las misiones se reinician autom√°ticamente cada d√≠a a las 5:00 AM', 'info');
            }

            // Tab Switching (Mobile)
            switchTab(tab) {
                // Update active state
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                // Scroll to section
                const sections = {
                    quests: document.querySelector('.glass-card'),
                    party: document.querySelector('.glass-card:nth-child(3)'),
                    shop: null, // Opens modal
                    avatar: null, // Opens modal
                    profile: null // Opens modal
                };
                
                if (sections[tab]) {
                    sections[tab].scrollIntoView({ behavior: 'smooth' });
                } else {
                    // Open corresponding modal
                    if (tab === 'shop') this.openShopModal();
                    if (tab === 'avatar') this.openAvatarModal();
                    if (tab === 'profile') this.openProfileModal();
                }
            }

            hideLoading() {
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                }, 1000);
            }

            // Cleanup on page unload
            destroy() {
                this.cleanupEventListeners();
                this.audio.destroy();
                this.saveData();
            }
        }

        // Initialize App
        let app;
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                app = new LifeQuestApp();
                
                // Make app globally accessible for onclick handlers
                window.app = app;
                
                // Cleanup on unload
                window.addEventListener('beforeunload', () => {
                    if (app) app.destroy();
                });
                
            } catch (error) {
                console.error('Fatal error initializing app:', error);
                alert('Error al iniciar LifeQuest RPG. Por favor recarga la p√°gina.');
            }
        });

        // Handle file import via drag and drop
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.json')) {
                if (confirm('¬øImportar estos datos? Se combinar√°n con tu progreso actual.')) {
                    app.importData(files[0]);
                }
            }
        });
    </script>
</body>
</html>
