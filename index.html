<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self';">
    <title>LifeQuest RPG - Cosmic Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --accent: #8b5cf6;
            --xp: #fbbf24;
            --gold: #f59e0b;
            --party: #06b6d4;
            --cosmetic: #a855f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--darker);
            color: var(--light);
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: 90px;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            animation: bgPulse 8s ease-in-out infinite;
        }

        @keyframes bgPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes rotate-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .aura-magic {
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(168,85,247,0.4) 0%, transparent 70%);
            animation: pulse 2s infinite;
            pointer-events: none;
        }

        .aura-fire {
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(239,68,68,0.3) 0%, transparent 70%);
            animation: float 3s ease-in-out infinite;
            pointer-events: none;
        }

        .aura-ice {
            position: absolute;
            inset: -5px;
            border: 2px solid rgba(147,197,253,0.5);
            border-radius: 50%;
            animation: rotate-slow 10s linear infinite;
            pointer-events: none;
        }

        .aura-gold {
            position: absolute;
            inset: -15px;
            border-radius: 50%;
            border: 3px dashed rgba(251,191,36,0.4);
            animation: rotate-slow 15s linear infinite;
            pointer-events: none;
        }

        .aura-shadow {
            position: absolute;
            inset: -10px;
            background: radial-gradient(circle, rgba(0,0,0,0.6) 0%, transparent 70%);
            border-radius: 50%;
            animation: pulse 4s infinite;
            pointer-events: none;
        }

        .mobile-header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 0.8rem;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: var(--light);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: rgba(99, 102, 241, 0.3);
            transform: scale(1.1);
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .badge.cosmetic {
            background: var(--cosmetic);
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .quick-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 0.6rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .quick-stat:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .quick-stat-icon {
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }

        .quick-stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--xp);
        }

        .quick-stat-label {
            font-size: 0.6rem;
            color: #64748b;
            text-transform: uppercase;
        }

        .character-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 20px;
            margin: 1rem;
            padding: 1.2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            overflow: hidden;
        }

        .character-avatar-container {
            position: relative;
            flex-shrink: 0;
        }

        .character-avatar {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
            overflow: visible;
        }

        .character-avatar:hover {
            transform: scale(1.1);
        }

        .avatar-hat {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8rem;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .avatar-glasses {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.4rem;
            z-index: 10;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
        }

        .avatar-cape {
            position: absolute;
            top: 20px;
            right: -10px;
            font-size: 2rem;
            z-index: 5;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .level-ring {
            position: absolute;
            inset: -5px;
            border: 2px solid transparent;
            border-top-color: var(--xp);
            border-radius: 50%;
            animation: spin 4s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .character-info {
            flex: 1;
        }

        .character-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            margin-bottom: 0.2rem;
        }

        .character-class {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 0.6rem;
        }

        .character-bars {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .bar-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bar-label {
            font-size: 0.7rem;
            color: #64748b;
            width: 25px;
        }

        .bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .hp-fill { background: linear-gradient(90deg, var(--danger), var(--warning)); }
        .xp-fill { background: linear-gradient(90deg, var(--xp), #f59e0b); }

        .tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0 1rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 0.7rem 1.2rem;
            color: #94a3b8;
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .section {
            display: none;
            padding: 0 1rem;
            animation: fadeIn 0.3s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }

        .category-card:hover {
            transform: translateX(5px);
            border-color: rgba(99, 102, 241, 0.4);
        }

        .category-card.health { border-left-color: var(--success); }
        .category-card.work { border-left-color: var(--primary); }
        .category-card.mind { border-left-color: var(--secondary); }
        .category-card.social { border-left-color: var(--warning); }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }

        .category-title-group {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .health-icon { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .work-icon { background: rgba(99, 102, 241, 0.2); color: var(--primary); }
        .mind-icon { background: rgba(236, 72, 153, 0.2); color: var(--secondary); }
        .social-icon { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

        .category-title {
            font-weight: 700;
            font-size: 1rem;
        }

        .category-progress {
            font-size: 0.75rem;
            color: #64748b;
        }

        .quest-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .quest-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
        }

        .quest-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: transparent;
            transition: all 0.3s;
        }

        .quest-item:hover::before {
            background: var(--primary);
        }

        .quest-item:active {
            transform: scale(0.98);
        }

        .quest-item.completed {
            opacity: 0.6;
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .quest-item.completed::before {
            background: var(--success);
        }

        .quest-checkbox {
            width: 26px;
            height: 26px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .quest-item:hover .quest-checkbox {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .quest-item.completed .quest-checkbox {
            background: var(--success);
            border-color: var(--success);
            animation: checkPop 0.3s;
        }

        @keyframes checkPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .quest-content {
            flex: 1;
            min-width: 0;
        }

        .quest-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.3s;
        }

        .quest-item.completed .quest-title {
            text-decoration: line-through;
            color: #64748b;
        }

        .quest-meta {
            display: flex;
            gap: 0.6rem;
            font-size: 0.7rem;
            color: #64748b;
            align-items: center;
            flex-wrap: wrap;
        }

        .streak-badge {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 0.2rem;
            font-weight: 600;
        }

        .difficulty-dots {
            display: flex;
            gap: 2px;
        }

        .dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
        }

        .dot.active { background: var(--warning); }

        .quest-reward {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .xp-reward {
            color: var(--xp);
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            font-size: 0.85rem;
        }

        .gold-reward {
            color: var(--gold);
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.2rem;
        }

        .quest-actions {
            display: flex;
            gap: 0.3rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .quest-item:hover .quest-actions {
            opacity: 1;
        }

        .quest-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .quest-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .quest-btn.delete:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        .quest-btn.edit {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .quest-btn.edit:hover {
            background: rgba(99, 102, 241, 0.4);
        }

        .party-section {
            padding: 0 1rem;
        }

        .party-code-card {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(99, 102, 241, 0.1));
            border: 2px dashed var(--party);
            border-radius: 16px;
            padding: 1.2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .party-code-label {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .party-code-value {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            color: var(--party);
            letter-spacing: 4px;
            margin-bottom: 1rem;
            text-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
        }

        .party-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .party-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .party-btn.primary {
            background: var(--party);
            color: white;
        }

        .party-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: var(--light);
        }

        .party-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .boss-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(245, 158, 11, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .boss-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .boss-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--danger), var(--warning));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .boss-info {
            flex: 1;
        }

        .boss-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--danger);
            margin-bottom: 0.2rem;
        }

        .boss-level {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .boss-hp-bar {
            height: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .boss-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger), var(--warning));
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .boss-hp-text {
            text-align: center;
            font-size: 0.8rem;
            color: #94a3b8;
            font-family: 'Orbitron', monospace;
        }

        .boss-rewards {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .boss-reward {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
        }

        .party-members {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .party-member {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transition: all 0.3s;
        }

        .party-member:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(5px);
        }

        .party-member-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
        }

        .party-member-status {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--dark);
        }

        .status-online { background: var(--success); }
        .status-away { background: var(--warning); }
        .status-offline { background: #64748b; }

        .party-member-info {
            flex: 1;
        }

        .party-member-name {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .party-member-level {
            font-size: 0.75rem;
            color: #64748b;
        }

        .party-member-xp {
            font-size: 0.8rem;
            color: var(--xp);
            font-family: 'Orbitron', monospace;
        }

        .chat-container {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            overflow: hidden;
        }

        .chat-messages {
            height: 250px;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .chat-message {
            display: flex;
            gap: 0.6rem;
            max-width: 85%;
        }

        .chat-message.system {
            align-self: center;
            max-width: 100%;
            opacity: 0.7;
        }

        .chat-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .chat-message.system .chat-avatar {
            background: rgba(255,255,255,0.1);
            font-size: 0.8rem;
        }

        .chat-content {
            background: rgba(255,255,255,0.05);
            padding: 0.6rem 0.8rem;
            border-radius: 12px;
            border-bottom-left-radius: 4px;
        }

        .chat-message.system .chat-content {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .chat-author {
            font-size: 0.75rem;
            color: var(--party);
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .chat-text {
            font-size: 0.85rem;
            line-height: 1.4;
            word-break: break-word;
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
            padding: 0.8rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }

        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 0.6rem 1rem;
            color: var(--light);
            font-family: inherit;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s;
        }

        .chat-input:focus {
            border-color: var(--party);
            background: rgba(255,255,255,0.08);
        }

        .chat-send {
            width: 36px;
            height: 36px;
            background: var(--party);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-send:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.5);
        }

        .shop-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            scrollbar-width: none;
        }

        .shop-filters::-webkit-scrollbar {
            display: none;
        }

        .shop-filter {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            color: #94a3b8;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .shop-filter.active {
            background: var(--cosmetic);
            border-color: var(--cosmetic);
            color: white;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
        }

        .shop-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            border-color: var(--cosmetic);
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.2);
        }

        .shop-item.purchased {
            opacity: 0.6;
            border-color: var(--success);
        }

        .shop-item-icon {
            width: 60px;
            height: 60px;
            background: rgba(168, 85, 247, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 0.8rem;
            position: relative;
        }

        .shop-item-rarity {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .rarity-common { background: #64748b; color: white; }
        .rarity-rare { background: #3b82f6; color: white; }
        .rarity-epic { background: #a855f7; color: white; }
        .rarity-legendary { 
            background: linear-gradient(135deg, #fbbf24, #f59e0b); 
            color: #000;
        }

        .shop-item-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .shop-item-type {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.8rem;
        }

        .shop-item-price {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            color: var(--gold);
            margin-bottom: 0.8rem;
        }

        .shop-item-btn {
            width: 100%;
            padding: 0.6rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .shop-item-btn.buy {
            background: var(--cosmetic);
            color: white;
        }

        .shop-item-btn.buy:hover:not(:disabled) {
            background: #9333ea;
            transform: scale(1.02);
        }

        .shop-item-btn:disabled {
            background: rgba(255,255,255,0.1);
            color: #64748b;
            cursor: not-allowed;
        }

        .shop-item-btn.equip {
            background: var(--success);
            color: white;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
        }

        .inventory-item {
            aspect-ratio: 1;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(168, 85, 247, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .inventory-item:hover {
            border-color: var(--cosmetic);
            transform: scale(1.05);
        }

        .inventory-item.equipped {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .inventory-item-slot {
            position: absolute;
            bottom: 0.3rem;
            right: 0.3rem;
            font-size: 0.6rem;
            background: rgba(0,0,0,0.5);
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            color: #94a3b8;
        }

        .avatar-preview-section {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            margin: 0 auto 1rem;
            position: relative;
            box-shadow: 0 0 40px rgba(99, 102, 241, 0.4);
        }

        .avatar-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .avatar-option {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .avatar-option:hover {
            background: rgba(255,255,255,0.1);
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.2);
        }

        .color-options {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-option:hover {
            transform: scale(1.2);
        }

        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 20px currentColor;
        }

        .equipped-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin-top: 1.5rem;
        }

        .equipped-slot {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
        }

        .equipped-slot-label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 0.3rem;
        }

        .equipped-slot-item {
            font-size: 1.5rem;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-section {
            padding: 0 1rem;
        }

        .profile-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            position: relative;
        }

        .profile-info h3 {
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 0.3rem;
        }

        .profile-info p {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .profile-stat {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .profile-stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            color: var(--xp);
            margin-bottom: 0.2rem;
        }

        .profile-stat-label {
            font-size: 0.75rem;
            color: #64748b;
        }

        .profile-menu {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .profile-menu-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-menu-item:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(5px);
            border-color: var(--primary);
        }

        .profile-menu-icon {
            width: 40px;
            height: 40px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .profile-menu-text {
            flex: 1;
        }

        .profile-menu-title {
            font-weight: 600;
            margin-bottom: 0.1rem;
        }

        .profile-menu-desc {
            font-size: 0.75rem;
            color: #64748b;
        }

        .profile-menu-arrow {
            color: #64748b;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
        }

        .achievement-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            opacity: 0.5;
            transition: all 0.3s;
        }

        .achievement-item.unlocked {
            opacity: 1;
            border-color: var(--xp);
            background: rgba(251, 191, 36, 0.05);
        }

        .achievement-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .achievement-item.unlocked .achievement-icon {
            background: rgba(251, 191, 36, 0.2);
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-name {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .achievement-desc {
            font-size: 0.7rem;
            color: #64748b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 1.2rem;
            text-align: center;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            color: var(--xp);
            margin-bottom: 0.3rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #64748b;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(99, 102, 241, 0.2);
            display: flex;
            justify-content: space-around;
            padding: 0.8rem 0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            color: #64748b;
            text-decoration: none;
            font-size: 0.7rem;
            transition: all 0.3s;
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .nav-icon {
            font-size: 1.4rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
            animation: modalIn 0.3s;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 0.98));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .form-input, .form-select {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 0.9rem 1rem;
            color: var(--light);
            font-family: inherit;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--primary);
            background: rgba(255,255,255,0.08);
        }

        .difficulty-selector {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .difficulty-option {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .difficulty-option:hover {
            background: rgba(255,255,255,0.1);
        }

        .difficulty-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .difficulty-option .stars {
            color: var(--warning);
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }

        .difficulty-option .label {
            font-size: 0.75rem;
            color: #64748b;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
            max-width: 90%;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .toast-text {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .confirm-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 2500;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .confirm-dialog.active {
            display: flex;
        }

        .confirm-box {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.99));
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 24px;
            padding: 2rem;
            text-align: center;
            max-width: 350px;
            width: 100%;
            animation: modalIn 0.3s;
        }

        .confirm-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .confirm-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: var(--danger);
        }

        .confirm-text {
            color: #94a3b8;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 1rem;
        }

        .confirm-btn {
            flex: 1;
            padding: 0.9rem;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-btn.cancel {
            background: rgba(255,255,255,0.1);
            color: #94a3b8;
        }

        .confirm-btn.confirm {
            background: var(--danger);
            color: white;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
        }

        .notification-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 380px;
            height: 100%;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(99, 102, 241, 0.2);
            z-index: 1500;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .notification-panel.active {
            right: 0;
        }

        .notification-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notification-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
        }

        .notification-close {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .notification-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            display: flex;
            gap: 0.8rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .notification-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .notification-item.unread {
            border-left: 3px solid var(--primary);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-item-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }

        .notification-text {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 0.3rem;
        }

        .notification-time {
            font-size: 0.7rem;
            color: #64748b;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 0.9rem;
        }

        .level-up-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .level-up-modal.active {
            display: flex;
            animation: levelUpIn 0.5s;
        }

        @keyframes levelUpIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        .level-up-content {
            text-align: center;
            padding: 2rem;
        }

        .level-up-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            background: linear-gradient(to right, var(--xp), #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }
            50% { text-shadow: 0 0 40px rgba(251, 191, 36, 0.8); }
        }

        .level-up-level {
            font-size: 5rem;
            font-family: 'Orbitron', monospace;
            color: var(--xp);
            margin-bottom: 1rem;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .level-up-rewards {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .level-up-reward {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .level-up-reward-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .level-up-reward-text {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .level-up-btn {
            background: linear-gradient(135deg, var(--xp), #f59e0b);
            color: #000;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        @media (min-width: 768px) {
            .mobile-header, .bottom-nav {
                max-width: 600px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
                right: auto;
                width: 100%;
            }
            
            body {
                max-width: 600px;
                margin: 0 auto;
                border-left: 1px solid rgba(99, 102, 241, 0.2);
                border-right: 1px solid rgba(99, 102, 241, 0.2);
            }
        }

        .add-quest-btn {
            position: fixed;
            bottom: 100px;
            right: 1.5rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .add-quest-btn:hover {
            transform: scale(1.1) rotate(90deg);
        }

        .add-quest-btn.party {
            bottom: 170px;
            background: linear-gradient(135deg, var(--party), var(--primary));
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--darker);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .loading-text {
            font-family: 'Orbitron', sans-serif;
            color: #94a3b8;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Cargando LifeQuest...</div>
    </div>

    <div class="confirm-dialog" id="confirm-dialog">
        <div class="confirm-box">
            <div class="confirm-icon" id="confirm-icon"></div>
            <div class="confirm-title" id="confirm-title">Ests seguro?</div>
            <div class="confirm-text" id="confirm-text">Esta accin no se puede deshacer</div>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" onclick="closeConfirmDialog()">Cancelar</button>
                <button class="confirm-btn confirm" id="confirm-action" onclick="executeConfirmAction()">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="level-up-modal" id="level-up-modal">
        <div class="level-up-content">
            <div class="level-up-title">SUBISTE DE NIVEL!</div>
            <div class="level-up-level" id="new-level">2</div>
            <div class="level-up-rewards">
                <div class="level-up-reward">
                    <div class="level-up-reward-icon"></div>
                    <div class="level-up-reward-text">+20 HP Mx</div>
                </div>
                <div class="level-up-reward">
                    <div class="level-up-reward-icon"></div>
                    <div class="level-up-reward-text">Nuevas habilidades</div>
                </div>
            </div>
            <button class="level-up-btn" onclick="closeLevelUpModal()">Continuar Aventura!</button>
        </div>
    </div>

    <div class="notification-panel" id="notification-panel">
        <div class="notification-header">
            <div class="notification-title"> Notificaciones</div>
            <button class="notification-close" onclick="toggleNotifications()"></button>
        </div>
        <div class="notification-list" id="notifications-list">
            <div class="empty-state">
                <div class="empty-state-icon"></div>
                <div class="empty-state-text">No tienes notificaciones</div>
            </div>
        </div>
    </div>

    <header class="mobile-header">
        <div class="header-top">
            <div class="logo"> LifeQuest</div>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleNotifications()" aria-label="Notificaciones">
                    
                    <span class="badge" id="notif-badge" style="display: none;">0</span>
                </button>
                <button class="icon-btn" onclick="openCosmeticShop()" aria-label="Tienda de cosmticos">
                    
                    <span class="badge cosmetic" id="cosmetic-badge" style="display: none;">0</span>
                </button>
            </div>
        </div>
        <div class="quick-stats">
            <div class="quick-stat">
                <div class="quick-stat-icon"></div>
                <div class="quick-stat-value" id="header-xp">0</div>
                <div class="quick-stat-label">XP</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon"></div>
                <div class="quick-stat-value" id="header-gold">100</div>
                <div class="quick-stat-label">ORO</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon"></div>
                <div class="quick-stat-value" id="header-streak">0</div>
                <div class="quick-stat-label">RACHA</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon"></div>
                <div class="quick-stat-value" id="header-gems">0</div>
                <div class="quick-stat-label">GEMAS</div>
            </div>
        </div>
    </header>

    <div class="character-card">
        <div class="character-avatar-container">
            <div class="character-avatar" id="header-avatar" onclick="openProfile()">
                <div class="level-ring"></div>
                <span id="avatar-emoji"></span>
            </div>
        </div>
        <div class="character-info">
            <div class="character-name" id="char-name">Hroe</div>
            <div class="character-class" id="char-class">Nv. 1 Aventurero</div>
            <div class="character-bars">
                <div class="bar-container">
                    <span class="bar-label">HP</span>
                    <div class="bar">
                        <div class="bar-fill hp-fill" id="hp-bar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="bar-container">
                    <span class="bar-label">XP</span>
                    <div class="bar">
                        <div class="bar-fill xp-fill" id="xp-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tabs" id="main-tabs">
        <button class="tab active" onclick="switchTab('quests')" data-tab="quests">
            <span></span> Misiones
        </button>
        <button class="tab" onclick="switchTab('party')" data-tab="party">
            <span></span> Party
        </button>
        <button class="tab" onclick="switchTab('shop')" data-tab="shop">
            <span></span> Tienda
        </button>
        <button class="tab" onclick="switchTab('avatar')" data-tab="avatar">
            <span></span> Avatar
        </button>
        <button class="tab" onclick="switchTab('profile')" data-tab="profile">
            <span></span> Perfil
        </button>
    </div>

    <section class="section active" id="quests-section">
        <div class="section-title">
            <span></span> Las misiones se reinician automticamente cada da a las 5:00 AM
        </div>
        
        <div class="category-card health">
            <div class="category-header">
                <div class="category-title-group">
                    <div class="category-icon health-icon"></div>
                    <div>
                        <div class="category-title">Salud & Fitness</div>
                    </div>
                </div>
                <div class="category-progress" id="health-progress">0/2 completadas</div>
            </div>
            <div class="quest-list" id="health-quests"></div>
        </div>

        <div class="category-card work">
            <div class="category-header">
                <div class="category-title-group">
                    <div class="category-icon work-icon"></div>
                    <div>
                        <div class="category-title">Trabajo & Productividad</div>
                    </div>
                </div>
                <div class="category-progress" id="work-progress">0/1 completadas</div>
            </div>
            <div class="quest-list" id="work-quests"></div>
        </div>

        <div class="category-card mind">
            <div class="category-header">
                <div class="category-title-group">
                    <div class="category-icon mind-icon"></div>
                    <div>
                        <div class="category-title">Mente & Crecimiento</div>
                    </div>
                </div>
                <div class="category-progress" id="mind-progress">0/1 completadas</div>
            </div>
            <div class="quest-list" id="mind-quests"></div>
        </div>

        <div class="category-card social">
            <div class="category-header">
                <div class="category-title-group">
                    <div class="category-icon social-icon"></div>
                    <div>
                        <div class="category-title">Social & Relaciones</div>
                    </div>
                </div>
                <div class="category-progress" id="social-progress">0/1 completadas</div>
            </div>
            <div class="quest-list" id="social-quests"></div>
        </div>
    </section>

    <section class="section" id="party-section">
        <div class="party-section">
            <div class="party-code-card">
                <div class="party-code-label">Cdigo de Party</div>
                <div class="party-code-value" id="party-code">XP7-9Q2</div>
                <div class="party-actions">
                    <button class="party-btn primary" onclick="copyPartyCode()">
                        <span></span> Copiar
                    </button>
                    <button class="party-btn secondary" onclick="sharePartyCode()">
                        <span></span> Compartir
                    </button>
                </div>
            </div>

            <div class="boss-card">
                <div class="boss-header">
                    <div class="boss-avatar"></div>
                    <div class="boss-info">
                        <div class="boss-name">Procrastinacin Suprema</div>
                        <div class="boss-level">Jefe Semanal  Nv. 5</div>
                    </div>
                </div>
                <div class="boss-hp-bar">
                    <div class="boss-hp-fill" id="boss-hp" style="width: 75%"></div>
                </div>
                <div class="boss-hp-text" id="boss-hp-text">750/1000 HP</div>
                <div class="boss-rewards">
                    <div class="boss-reward">
                        <span></span> +500 XP
                    </div>
                    <div class="boss-reward">
                        <span></span> +100 Oro
                    </div>
                    <div class="boss-reward">
                        <span></span> Cofre pico
                    </div>
                </div>
            </div>

            <div class="section-title">Miembros del Equipo</div>
            <div class="party-members" id="party-members"></div>

            <div class="section-title">Chat de Party</div>
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Escribe un mensaje..." maxlength="200">
                    <button class="chat-send" onclick="sendMessage()"></button>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="shop-section">
        <div class="shop-filters">
            <button class="shop-filter active" onclick="filterShop('all')">Todos</button>
            <button class="shop-filter" onclick="filterShop('hat')">Sombreros</button>
            <button class="shop-filter" onclick="filterShop('glasses')">Gafas</button>
            <button class="shop-filter" onclick="filterShop('cape')">Capas</button>
            <button class="shop-filter" onclick="filterShop('aura')">Auras</button>
            <button class="shop-filter" onclick="filterShop('accessory')">Accesorios</button>
        </div>
        <div class="shop-grid" id="shop-grid"></div>
    </section>

    <section class="section" id="avatar-section">
        <div class="avatar-preview-section">
            <div class="avatar-preview" id="avatar-preview">
                <div class="level-ring"></div>
                <span id="preview-emoji"></span>
            </div>
            <div class="section-title" style="margin-bottom: 0.5rem;">Elige tu Avatar</div>
        </div>

        <div class="avatar-options" id="avatar-options"></div>

        <div class="section-title">Color de Fondo</div>
        <div class="color-options" id="color-options"></div>

        <div class="section-title">Mi Inventario</div>
        <div class="inventory-grid" id="inventory-grid"></div>

        <div class="equipped-items" id="equipped-items"></div>
    </section>

    <section class="section" id="profile-section">
        <div class="profile-section">
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar" id="profile-avatar"></div>
                    <div class="profile-info">
                        <h3 id="profile-name">Hroe</h3>
                        <p id="profile-email">jugador@lifequest.com</p>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="total-completed">0</div>
                        <div class="profile-stat-label">Misiones</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="max-streak">0</div>
                        <div class="profile-stat-label">Mejor Racha</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="current-level">1</div>
                        <div class="profile-stat-label">Nivel</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="total-xp">0</div>
                        <div class="profile-stat-label">XP Total</div>
                    </div>
                </div>
            </div>

            <div class="profile-menu">
                <div class="profile-menu-item" onclick="openProfileEdit()">
                    <div class="profile-menu-icon"></div>
                    <div class="profile-menu-text">
                        <div class="profile-menu-title">Editar Perfil</div>
                        <div class="profile-menu-desc">Cambia tu nombre y email</div>
                    </div>
                    <div class="profile-menu-arrow"></div>
                </div>
                <div class="profile-menu-item" onclick="openAvatarSection()">
                    <div class="profile-menu-icon"></div>
                    <div class="profile-menu-text">
                        <div class="profile-menu-title">Personalizar Avatar</div>
                        <div class="profile-menu-desc">Cambia tu apariencia</div>
                    </div>
                    <div class="profile-menu-arrow"></div>
                </div>
                <div class="profile-menu-item" onclick="switchTab('profile', 'stats')">
                    <div class="profile-menu-icon"></div>
                    <div class="profile-menu-text">
                        <div class="profile-menu-title">Mis Estadsticas</div>
                        <div class="profile-menu-desc">Ver tu progreso detallado</div>
                    </div>
                    <div class="profile-menu-arrow"></div>
                </div>
                <div class="profile-menu-item" onclick="switchTab('profile', 'achievements')">
                    <div class="profile-menu-icon"></div>
                    <div class="profile-menu-text">
                        <div class="profile-menu-title">Logros Desbloqueados</div>
                        <div class="profile-menu-desc" id="achievements-count">0 de 161 logros</div>
                    </div>
                    <div class="profile-menu-arrow"></div>
                </div>
                <div class="profile-menu-item" onclick="exportData()">
                    <div class="profile-menu-icon"></div>
                    <div class="profile-menu-text">
                        <div class="profile-menu-title">Exportar Datos</div>
                        <div class="profile-menu-desc">Guarda tu progreso</div>
                    </div>
                    <div class="profile-menu-arrow"></div>
                </div>
                <div class="profile-menu-item" onclick="confirmResetData()">
                    <div class="profile-menu-icon"></div>
                    <div class="profile-menu-text">
                        <div class="profile-menu-title" style="color: var(--danger)">Reiniciar Progreso</div>
                        <div class="profile-menu-desc">Borra todos tus datos</div>
                    </div>
                    <div class="profile-menu-arrow"></div>
                </div>
            </div>

            <div class="section-title" style="margin-top: 2rem;"> ltimos Logros</div>
            <div id="recent-achievements"></div>
        </div>
    </section>

    <section class="section" id="stats-section">
        <div class="profile-section">
            <div class="section-title"> Estadsticas</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="stat-quests">0</div>
                    <div class="stat-label">Misiones Completadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="stat-streak">0</div>
                    <div class="stat-label">Racha Actual</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="stat-perfect">0</div>
                    <div class="stat-label">Das Perfectos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="stat-bosses">0</div>
                    <div class="stat-label">Jefes Derrotados</div>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="achievements-section">
        <div class="profile-section">
            <div class="section-title"> Logros Desbloqueados</div>
            <div class="achievements-grid" id="achievements-grid"></div>
        </div>
    </section>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" onclick="switchTab('quests'); return false;" data-nav="quests">
            <span class="nav-icon"></span>
            <span>Misiones</span>
        </a>
        <a href="#" class="nav-item" onclick="switchTab('party'); return false;" data-nav="party">
            <span class="nav-icon"></span>
            <span>Party</span>
        </a>
        <a href="#" class="nav-item" onclick="switchTab('shop'); return false;" data-nav="shop">
            <span class="nav-icon"></span>
            <span>Tienda</span>
        </a>
        <a href="#" class="nav-item" onclick="switchTab('avatar'); return false;" data-nav="avatar">
            <span class="nav-icon"></span>
            <span>Avatar</span>
        </a>
        <a href="#" class="nav-item" onclick="switchTab('profile'); return false;" data-nav="profile">
            <span class="nav-icon"></span>
            <span>Perfil</span>
        </a>
    </nav>

    <button class="add-quest-btn" onclick="openQuestModal()" aria-label="Aadir misin">+</button>

    <div class="modal" id="quest-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"> Nueva Misin</div>
                <button class="modal-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
                <form onsubmit="addQuest(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre de la misin</label>
                        <input type="text" class="form-input" id="quest-name" placeholder="Qu vas a lograr hoy?" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categora</label>
                        <select class="form-select" id="quest-category">
                            <option value="health"> Salud & Fitness</option>
                            <option value="work"> Trabajo & Productividad</option>
                            <option value="mind"> Mente & Crecimiento</option>
                            <option value="social"> Social & Relaciones</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dificultad</label>
                        <div class="difficulty-selector">
                            <div class="difficulty-option" onclick="selectDifficulty(1)">
                                <div class="stars"></div>
                                <div class="label">Fcil</div>
                            </div>
                            <div class="difficulty-option selected" onclick="selectDifficulty(2)">
                                <div class="stars"></div>
                                <div class="label">Normal</div>
                            </div>
                            <div class="difficulty-option" onclick="selectDifficulty(3)">
                                <div class="stars"></div>
                                <div class="label">Difcil</div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Crear Misin</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="edit-quest-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"> Editar Misin</div>
                <button class="modal-close" onclick="closeEditModal()"></button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveQuestEdit(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre de la misin</label>
                        <input type="text" class="form-input" id="edit-quest-name" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categora</label>
                        <select class="form-select" id="edit-quest-category">
                            <option value="health"> Salud & Fitness</option>
                            <option value="work"> Trabajo & Productividad</option>
                            <option value="mind"> Mente & Crecimiento</option>
                            <option value="social"> Social & Relaciones</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dificultad</label>
                        <div class="difficulty-selector" id="edit-difficulty-selector">
                            <div class="difficulty-option" onclick="selectEditDifficulty(1)">
                                <div class="stars"></div>
                                <div class="label">Fcil</div>
                            </div>
                            <div class="difficulty-option selected" onclick="selectEditDifficulty(2)">
                                <div class="stars"></div>
                                <div class="label">Normal</div>
                            </div>
                            <div class="difficulty-option" onclick="selectEditDifficulty(3)">
                                <div class="stars"></div>
                                <div class="label">Difcil</div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"> Editar Perfil</div>
                <button class="modal-close" onclick="closeProfileModal()"></button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveProfile(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre de hroe</label>
                        <input type="text" class="form-input" id="profile-name-input" placeholder="Tu nombre" required maxlength="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email (opcional)</label>
                        <input type="email" class="form-input" id="profile-email-input" placeholder="tu@email.com" maxlength="50">
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Perfil</button>
                </form>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <div class="toast-icon" id="toast-icon"></div>
        <div class="toast-content">
            <div class="toast-title" id="toast-title">xito!</div>
            <div class="toast-text" id="toast-text">Operacin completada</div>
        </div>
    </div>

    <script>
        // ==========================================
        // SECCIN 1: UTILIDADES SEGURAS
        // ==========================================
        
        const Sanitizer = {
            escapeHtml(text) {
                if (typeof text !== 'string') return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            escapeAttribute(text) {
                if (typeof text !== 'string') return '';
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }
        };

        const IdGenerator = {
            generate() {
                if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                const timestamp = Date.now().toString(36);
                const random = Math.random().toString(36).substring(2, 15);
                const random2 = Math.random().toString(36).substring(2, 15);
                return `${timestamp}-${random}-${random2}`;
            },
            
            generateNumeric() {
                return Date.now() * 1000 + Math.floor(Math.random() * 1000);
            }
        };

        const Validator = {
            quest(quest) {
                const errors = [];
                if (!quest || typeof quest !== 'object') {
                    return { valid: false, errors: ['Quest invlido'] };
                }
                
                if (!quest.title || typeof quest.title !== 'string') {
                    errors.push('Ttulo requerido');
                } else if (quest.title.length > 100) {
                    errors.push('Ttulo muy largo (mx 100)');
                } else if (quest.title.trim().length === 0) {
                    errors.push('Ttulo no puede estar vaco');
                }
                
                if (!['health', 'work', 'mind', 'social'].includes(quest.category)) {
                    errors.push('Categora invlida');
                }
                
                if (![1, 2, 3].includes(quest.difficulty)) {
                    errors.push('Dificultad invlida');
                }
                
                return { valid: errors.length === 0, errors };
            },
            
            userName(name) {
                if (typeof name !== 'string') return false;
                const trimmed = name.trim();
                return trimmed.length > 0 && trimmed.length <= 20;
            }
        };

        const StorageManager = {
            STORAGE_KEY: 'lifequest_data_v5',
            SCHEMA_VERSION: 5,
            MAX_SIZE: 4 * 1024 * 1024,
            
            save(data) {
                try {
                    const payload = {
                        ...data,
                        _meta: {
                            version: this.SCHEMA_VERSION,
                            savedAt: new Date().toISOString(),
                            checksum: this.generateChecksum(data)
                        }
                    };
                    
                    const serialized = JSON.stringify(payload);
                    const size = new Blob([serialized]).size;
                    
                    if (size > this.MAX_SIZE) {
                        throw new Error(`Datos exceden lmite: ${(size/1024/1024).toFixed(2)}MB`);
                    }
                    
                    localStorage.setItem(this.STORAGE_KEY, serialized);
                    sessionStorage.setItem(`${this.STORAGE_KEY}_backup`, serialized);
                    
                    return { success: true, size };
                } catch (error) {
                    console.error('Error guardando:', error);
                    return { success: false, error: error.message };
                }
            },
            
            load() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    if (!data) return null;
                    
                    const parsed = JSON.parse(data);
                    
                    if (!parsed._meta || parsed._meta.version < this.SCHEMA_VERSION) {
                        return this.migrate(parsed);
                    }
                    
                    if (parsed._meta.checksum !== this.generateChecksum(parsed, true)) {
                        console.warn('Checksum mismatch, posible corrupcin');
                        return this.recoverFromBackup() || parsed;
                    }
                    
                    const { _meta, ...cleanData } = parsed;
                    return cleanData;
                    
                } catch (error) {
                    console.error('Error cargando:', error);
                    return this.recoverFromBackup();
                }
            },
            
            migrate(oldData) {
                console.log('Migrando datos de versin', oldData._meta?.version || 'desconocida');
                
                const migrations = {
                    1: (d) => ({ ...d, user: { ...d.user, avatarColor: 0, equippedCosmetics: {} } }),
                    2: (d) => ({ ...d, cosmetics: d.cosmetics || [] }),
                    3: (d) => ({ ...d, notifications: d.notifications || [] }),
                    4: (d) => ({ ...d, stats: { ...d.stats, cosmeticsBought: 0 } })
                };
                
                let currentVersion = oldData._meta?.version || 1;
                let migrated = { ...oldData };
                
                while (currentVersion < this.SCHEMA_VERSION) {
                    if (migrations[currentVersion]) {
                        migrated = migrations[currentVersion](migrated);
                    }
                    currentVersion++;
                }
                
                this.save(migrated);
                return migrated;
            },
            
            recoverFromBackup() {
                try {
                    const backup = sessionStorage.getItem(`${this.STORAGE_KEY}_backup`);
                    if (backup) {
                        console.log('Recuperando de backup');
                        return JSON.parse(backup);
                    }
                } catch (e) {
                    console.error('Backup tambin corrupto');
                }
                return null;
            },
            
            generateChecksum(data, excludeMeta = false) {
                const str = JSON.stringify(excludeMeta ? data : { ...data, _meta: undefined });
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(36);
            },
            
            clear() {
                localStorage.removeItem(this.STORAGE_KEY);
                sessionStorage.removeItem(`${this.STORAGE_KEY}_backup`);
            }
        };

        const AudioManager = {
            context: null,
            gainNode: null,
            
            init() {
                if (!this.context) {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    this.gainNode = this.context.createGain();
                    this.gainNode.connect(this.context.destination);
                }
                return this.context;
            },
            
            play(type) {
                if (!gameState.user.settings.sounds) return;
                
                try {
                    const ctx = this.init();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(this.gainNode);
                    
                    if (type === 'complete') {
                        osc.frequency.setValueAtTime(800, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.1);
                    } else if (type === 'levelup') {
                        osc.frequency.setValueAtTime(400, ctx.currentTime);
                        osc.frequency.linearRampToValueAtTime(1200, ctx.currentTime + 0.3);
                        gain.gain.setValueAtTime(0.2, ctx.currentTime);
                        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.3);
                    }
                    
                    setTimeout(() => {
                        osc.disconnect();
                        gain.disconnect();
                    }, 500);
                    
                } catch (e) {
                    console.error('Error de audio:', e);
                }
            },
            
            suspend() {
                if (this.context && this.context.state === 'running') {
                    this.context.suspend();
                }
            },
            
            resume() {
                if (this.context && this.context.state === 'suspended') {
                    this.context.resume();
                }
            }
        };

        // ==========================================
        // SECCIN 2: DATOS Y CONFIGURACIN
        // ==========================================

        const avatarOptions = ['', '', '', '', '', '', '', '', '', '', 
                              '', '', '', '', '', '', '', '', '', ''];
        
        const colorPalettes = [
            { name: 'Csmico', gradient: 'linear-gradient(135deg, #6366f1, #ec4899)', primary: '#6366f1' },
            { name: 'Fuego', gradient: 'linear-gradient(135deg, #ef4444, #f59e0b)', primary: '#ef4444' },
            { name: 'Naturaleza', gradient: 'linear-gradient(135deg, #10b981, #3b82f6)', primary: '#10b981' },
            { name: 'Oscuro', gradient: 'linear-gradient(135deg, #1e293b, #0f172a)', primary: '#1e293b' },
            { name: 'Dorado', gradient: 'linear-gradient(135deg, #fbbf24, #f59e0b)', primary: '#fbbf24' },
            { name: 'Hielo', gradient: 'linear-gradient(135deg, #06b6d4, #3b82f6)', primary: '#06b6d4' }
        ];

        const cosmeticsDB = [
            { id: 'hat_wizard', name: 'Sombrero de Mago', icon: '', type: 'hat', rarity: 'common', price: 50 },
            { id: 'hat_crown', name: 'Corona Real', icon: '', type: 'hat', rarity: 'legendary', price: 500 },
            { id: 'hat_cowboy', name: 'Sombrero Vaquero', icon: '', type: 'hat', rarity: 'rare', price: 150 },
            { id: 'hat_party', name: 'Gorro de Fiesta', icon: '', type: 'hat', rarity: 'common', price: 30 },
            { id: 'glasses_sun', name: 'Gafas de Sol', icon: '', type: 'glasses', rarity: 'common', price: 40 },
            { id: 'glasses_nerd', name: 'Gafas de Nerd', icon: '', type: 'glasses', rarity: 'common', price: 35 },
            { id: 'glasses_monocle', name: 'Monculo', icon: '', type: 'glasses', rarity: 'rare', price: 120 },
            { id: 'cape_hero', name: 'Capa de Hroe', icon: '', type: 'cape', rarity: 'epic', price: 300 },
            { id: 'cape_vampire', name: 'Capa Vampiro', icon: '', type: 'cape', rarity: 'rare', price: 180 },
            { id: 'aura_magic', name: 'Aura Mgica', icon: '', type: 'aura', rarity: 'epic', price: 400 },
            { id: 'aura_fire', name: 'Aura de Fuego', icon: '', type: 'aura', rarity: 'legendary', price: 600 },
            { id: 'aura_ice', name: 'Aura de Hielo', icon: '', type: 'aura', rarity: 'epic', price: 400 },
            { id: 'aura_gold', name: 'Aura Dorada', icon: '', type: 'aura', rarity: 'legendary', price: 800 },
            { id: 'aura_shadow', name: 'Aura Sombra', icon: '', type: 'aura', rarity: 'legendary', price: 750 },
            { id: 'accessory_pet', name: 'Mascota', icon: '', type: 'accessory', rarity: 'rare', price: 200 }
        ];

        const achievementsDB = [
            { id: 'first_quest', name: 'Primeros Pasos', desc: 'Completa tu primera misin', icon: '', condition: (s) => s.user.totalCompleted >= 1 },
            { id: 'ten_quests', name: 'Diez Victorias', desc: 'Completa 10 misiones', icon: '', condition: (s) => s.user.totalCompleted >= 10 },
            { id: 'fifty_quests', name: 'Maestro de Misiones', desc: 'Completa 50 misiones', icon: '', condition: (s) => s.user.totalCompleted >= 50 },
            { id: 'week_streak', name: 'Semana Perfecta', desc: '7 das de racha', icon: '', condition: (s) => s.user.longestStreak >= 7 },
            { id: 'month_streak', name: 'Mes Legendario', desc: '30 das de racha', icon: '', condition: (s) => s.user.longestStreak >= 30 },
            { id: 'first_shop', name: 'Comprador', desc: 'Compra tu primer item', icon: '', condition: (s) => s.stats.shopBuys >= 1 },
            { id: 'rich', name: 'Millonario', desc: 'Acumula 1000 de oro', icon: '', condition: (s) => s.user.gold >= 1000 },
            { id: 'level_5', name: 'Aprendiz', desc: 'Alcanza nivel 5', icon: '', condition: (s) => s.user.level >= 5 },
            { id: 'level_10', name: 'Experto', desc: 'Alcanza nivel 10', icon: '', condition: (s) => s.user.level >= 10 },
            { id: 'all_categories', name: 'Equilibrado', desc: 'Completa misiones de todas las categoras', icon: '', condition: (s) => Object.values(s.stats.questsByCategory).every(v => v > 0) }
        ];

        const shopItemsDB = [
            { id: 'potion_hp', name: 'Pocin de Vida', icon: '', type: 'consumable', price: 25, effect: 'hp', value: 20, desc: 'Restaura 20 HP' },
            { id: 'potion_xp', name: 'Pocin de XP', icon: '', type: 'consumable', price: 50, effect: 'xp', value: 50, desc: '+50 XP instantneo' },
            { id: 'scroll_reroll', name: 'Pergamino de Cambio', icon: '', type: 'consumable', price: 100, effect: 'reroll', value: 1, desc: 'Cambia una misin' },
            { id: 'chest_common', name: 'Cofre Comn', icon: '', type: 'chest', price: 75, rarity: 'common', desc: 'Contiene 50-100 de oro' },
            { id: 'chest_rare', name: 'Cofre Raro', icon: '', type: 'chest', price: 200, rarity: 'rare', desc: 'Contiene 150-300 de oro + item' },
            { id: 'chest_epic', name: 'Cofre pico', icon: '', type: 'chest', price: 500, rarity: 'epic', desc: 'Contiene 400-800 de oro + item pico' }
        ];

        const DEFAULT_GAME_STATE = {
            user: {
                name: 'Hroe',
                level: 1,
                xp: 0,
                xpToNext: 100,
                gold: 100,
                hp: 100,
                maxHp: 100,
                streak: 0,
                avatar: '',
                avatarColor: 0,
                totalCompleted: 0,
                totalXp: 0,
                settings: {
                    notifications: true,
                    sounds: true
                },
                lastLogin: null,
                currentStreak: 0,
                longestStreak: 0,
                lastResetDate: null,
                equippedCosmetics: {
                    hat: null,
                    glasses: null,
                    cape: null,
                    aura: null,
                    accessory: null
                },
                joinDate: null
            },
            cosmetics: cosmeticsDB.map(c => ({...c, purchased: false, equipped: false})),
            party: {
                code: 'XP7-9Q2',
                members: [
                    { id: IdGenerator.generate(), name: 'T', level: 1, avatar: '', isYou: true, isLeader: true, status: 'online' },
                    { id: IdGenerator.generate(), name: 'Mara', level: 3, avatar: '', isYou: false, isLeader: false, status: 'online' },
                    { id: IdGenerator.generate(), name: 'Carlos', level: 2, avatar: '', isYou: false, isLeader: false, status: 'away' }
                ],
                boss: {
                    name: 'Procrastinacin Suprema',
                    hp: 750,
                    maxHp: 1000,
                    level: 5
                },
                chat: [
                    { id: IdGenerator.generate(), author: 'Mara', avatar: '', text: 'Vamos equipo! ', time: '10:30', isSystem: false },
                    { id: IdGenerator.generate(), author: 'Carlos', avatar: '', text: 'Ya hice 2 misiones hoy', time: '10:35', isSystem: false },
                    { id: IdGenerator.generate(), author: 'Sistema', avatar: '', text: 'El jefe est al 75% de HP', time: '10:40', isSystem: true }
                ]
            },
            quests: {
                health: [
                    { id: IdGenerator.generateNumeric(), title: 'Beber 2L de agua', difficulty: 2, completed: false, streak: 3, xp: 20, gold: 5, lastCompleted: null },
                    { id: IdGenerator.generateNumeric(), title: 'Ejercicio 30 minutos', difficulty: 3, completed: false, streak: 5, xp: 35, gold: 10, lastCompleted: null }
                ],
                work: [
                    { id: IdGenerator.generateNumeric(), title: 'Deep Work 2 horas', difficulty: 3, completed: false, streak: 2, xp: 40, gold: 12, lastCompleted: null }
                ],
                mind: [
                    { id: IdGenerator.generateNumeric(), title: 'Meditar 10 minutos', difficulty: 2, completed: false, streak: 7, xp: 25, gold: 6, lastCompleted: null }
                ],
                social: [
                    { id: IdGenerator.generateNumeric(), title: 'Llamar a un familiar', difficulty: 2, completed: false, streak: 1, xp: 30, gold: 8, lastCompleted: null }
                ]
            },
            shop: shopItemsDB.map(item => ({...item, purchased: false, purchaseDate: null})),
            myRewards: [],
            achievements: JSON.parse(JSON.stringify(achievementsDB)),
            notifications: [],
            stats: {
                questsByCategory: { health: 0, work: 0, mind: 0, social: 0 },
                totalQuestsCreated: 5,
                perfectDays: 0,
                currentPerfectDayStreak: 0,
                shopBuys: 0,
                profileEdits: 0,
                bossesDefeated: 0,
                cosmeticsBought: 0
            }
        };

        let gameState = JSON.parse(JSON.stringify(DEFAULT_GAME_STATE));
        let selectedDifficulty = 2;
        let editDifficulty = 2;
        let tempAvatar = '';
        let isFirstTime = false;
        let currentEditingQuest = null;
        let confirmCallback = null;
        let currentShopFilter = 'all';
        let currentCosmeticFilter = 'all';

        // ==========================================
        // SECCIN 3: FUNCIONES DE INICIALIZACIN
        // ==========================================

        function init() {
            try {
                loadGame();
                checkDailyReset();
                checkFirstTime();
                setupEventListeners();
                renderAll();
                updateStats();
                requestNotificationPermission();
                
                const intervals = [
                    setInterval(checkReminders, 60000),
                    setInterval(checkDailyReset, 60000)
                ];
                
                window.addEventListener('beforeunload', () => {
                    intervals.forEach(clearInterval);
                    AudioManager.suspend();
                });
                
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        AudioManager.suspend();
                    } else {
                        AudioManager.resume();
                    }
                });
                
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                }, 1000);
                
            } catch (error) {
                console.error('Error de inicializacin:', error);
                showToast('', 'Error', 'Hubo un problema al iniciar. Recargando...');
                setTimeout(() => location.reload(), 3000);
            }
        }

        function setupEventListeners() {
            const questModal = document.getElementById('quest-modal');
            questModal.addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });
            
            document.getElementById('confirm-cancel').onclick = closeConfirmDialog;
            document.getElementById('confirm-action').onclick = executeConfirmAction;
            
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendMessage();
                });
            }
        }

        function loadGame() {
            const saved = StorageManager.load();
            if (saved) {
                gameState = deepMergeWithValidation(DEFAULT_GAME_STATE, saved);
            }
            tempAvatar = gameState.user.avatar;
        }

        function deepMergeWithValidation(defaults, saved) {
            const result = JSON.parse(JSON.stringify(defaults));
            
            if (saved.user && typeof saved.user === 'object') {
                Object.keys(result.user).forEach(key => {
                    if (saved.user[key] !== undefined && 
                        typeof saved.user[key] === typeof result.user[key]) {
                        result.user[key] = saved.user[key];
                    }
                });
            }
            
            if (Array.isArray(saved.cosmetics)) {
                result.cosmetics = saved.cosmetics.filter(c => c && typeof c === 'object');
            }
            
            if (Array.isArray(saved.achievements)) {
                result.achievements = result.achievements.map(defaultAch => {
                    const savedAch = saved.achievements.find(a => a.id === defaultAch.id);
                    return savedAch ? { ...defaultAch, ...savedAch } : defaultAch;
                });
            }
            
            if (saved.quests && typeof saved.quests === 'object') {
                Object.keys(result.quests).forEach(cat => {
                    if (Array.isArray(saved.quests[cat])) {
                        result.quests[cat] = saved.quests[cat].filter(q => 
                            q && typeof q === 'object' && q.title && q.id
                        );
                    }
                });
            }
            
            return result;
        }

        function saveGame() {
            const result = StorageManager.save(gameState);
            if (!result.success) {
                showToast('', 'Error de Guardado', result.error || 'No se pudieron guardar los datos');
                if (result.error && result.error.includes('lmite')) {
                    const minimalState = {
                        user: gameState.user,
                        quests: gameState.quests,
                        stats: gameState.stats
                    };
                    StorageManager.save(minimalState);
                }
            }
            return result.success;
        }

        // ==========================================
        // SECCIN 4: RENDERIZADO SEGURO
        // ==========================================

        const SafeRenderer = {
            createElement(tag, classes = [], attributes = {}, textContent = '') {
                const el = document.createElement(tag);
                classes.forEach(c => el.classList.add(c));
                Object.entries(attributes).forEach(([key, val]) => {
                    if (key === 'style' && typeof val === 'object') {
                        Object.assign(el.style, val);
                    } else {
                        el.setAttribute(key, Sanitizer.escapeAttribute(String(val)));
                    }
                });
                if (textContent) el.textContent = textContent;
                return el;
            },
            
            renderQuests() {
                const categories = ['health', 'work', 'mind', 'social'];
                
                categories.forEach(cat => {
                    const container = document.getElementById(`${cat}-quests`);
                    if (!container) return;
                    
                    const quests = gameState.quests[cat];
                    const completed = quests.filter(q => q.completed).length;
                    
                    const progressEl = document.getElementById(`${cat}-progress`);
                    if (progressEl) {
                        progressEl.textContent = `${completed}/${quests.length} completadas`;
                    }
                    
                    container.innerHTML = '';
                    const fragment = document.createDocumentFragment();
                    
                    quests.forEach(quest => {
                        const questEl = this.createQuestElement(quest, cat);
                        fragment.appendChild(questEl);
                    });
                    
                    container.appendChild(fragment);
                });
            },
            
            createQuestElement(quest, category) {
                const div = this.createElement('div', 
                    ['quest-item', quest.completed ? 'completed' : ''].filter(Boolean),
                    { 'data-quest-id': quest.id, 'data-category': category }
                );
                
                const checkbox = this.createElement('div', ['quest-checkbox']);
                checkbox.textContent = quest.completed ? '' : '';
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    toggleQuest(category, quest.id);
                };
                
                const content = this.createElement('div', ['quest-content']);
                content.onclick = () => toggleQuest(category, quest.id);
                
                const title = this.createElement('div', ['quest-title'], {}, quest.title);
                
                const meta = this.createElement('div', ['quest-meta']);
                
                const streakBadge = this.createElement('span', ['streak-badge'], {}, ` ${quest.streak}`);
                
                const dots = this.createElement('div', ['difficulty-dots']);
                for (let i = 1; i <= 3; i++) {
                    const dot = this.createElement('div', ['dot', i <= quest.difficulty ? 'active' : ''].filter(Boolean));
                    dots.appendChild(dot);
                }
                
                meta.appendChild(streakBadge);
                meta.appendChild(dots);
                
                content.appendChild(title);
                content.appendChild(meta);
                
                const reward = this.createElement('div', ['quest-reward']);
                reward.onclick = () => toggleQuest(category, quest.id);
                
                const xpReward = this.createElement('div', ['xp-reward'], {}, `+${quest.xp}`);
                const goldReward = this.createElement('div', ['gold-reward'], {}, `${quest.gold} `);
                
                reward.appendChild(xpReward);
                reward.appendChild(goldReward);
                
                const actions = this.createElement('div', ['quest-actions']);
                actions.onclick = (e) => e.stopPropagation();
                
                const editBtn = this.createElement('button', ['quest-btn', 'edit'], { title: 'Editar' }, '');
                editBtn.onclick = () => openQuestEditModal(category, quest.id);
                
                const deleteBtn = this.createElement('button', ['quest-btn', 'delete'], { title: 'Eliminar' }, '');
                deleteBtn.onclick = () => confirmDeleteQuest(category, quest.id);
                
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                
                div.appendChild(checkbox);
                div.appendChild(content);
                div.appendChild(reward);
                div.appendChild(actions);
                
                div.ondblclick = () => openQuestEditModal(category, quest.id);
                
                return div;
            },
            
            renderChat() {
                const container = document.getElementById('chat-messages');
                if (!container) return;
                
                container.innerHTML = '';
                const fragment = document.createDocumentFragment();
                
                gameState.party.chat.forEach(msg => {
                    const msgEl = this.createChatMessageElement(msg);
                    fragment.appendChild(msgEl);
                });
                
                container.appendChild(fragment);
                container.scrollTop = container.scrollHeight;
            },
            
            createChatMessageElement(msg) {
                const div = this.createElement('div', 
                    ['chat-message', msg.isSystem ? 'system' : ''].filter(Boolean)
                );
                
                const avatar = this.createElement('div', ['chat-avatar'], {}, msg.avatar);
                
                const content = this.createElement('div', ['chat-content']);
                
                const author = this.createElement('div', ['chat-author'], 
                    { style: { color: msg.isSystem ? 'var(--party)' : 'inherit' } },
                    msg.author
                );
                
                const text = this.createElement('div', ['chat-text'], {}, msg.text);
                
                content.appendChild(author);
                content.appendChild(text);
                
                div.appendChild(avatar);
                div.appendChild(content);
                
                return div;
            },
            
            renderAchievements() {
                const container = document.getElementById('achievements-grid');
                if (!container) return;
                
                container.innerHTML = '';
                const fragment = document.createDocumentFragment();
                
                gameState.achievements.forEach(ach => {
                    const el = this.createAchievementElement(ach);
                    fragment.appendChild(el);
                });
                
                container.appendChild(fragment);
            },
            
            createAchievementElement(ach) {
                const div = this.createElement('div', 
                    ['achievement-item', ach.unlocked ? 'unlocked' : ''].filter(Boolean)
                );
                
                const icon = this.createElement('div', ['achievement-icon'], {}, ach.icon);
                
                const info = this.createElement('div', ['achievement-info']);
                const name = this.createElement('div', ['achievement-name'], {}, ach.name);
                const desc = this.createElement('div', ['achievement-desc'], {}, ach.desc);
                
                info.appendChild(name);
                info.appendChild(desc);
                
                div.appendChild(icon);
                div.appendChild(info);
                
                return div;
            },
            
            renderNotifications() {
                const container = document.getElementById('notifications-list');
                const badge = document.getElementById('notif-badge');
                
                if (!container) return;
                
                const unreadCount = gameState.notifications.filter(n => n.unread).length;
                
                if (badge) {
                    badge.textContent = unreadCount;
                    badge.style.display = unreadCount > 0 ? 'flex' : 'none';
                }
                
                container.innerHTML = '';
                
                if (gameState.notifications.length === 0) {
                    const empty = this.createElement('div', ['empty-state']);
                    const icon = this.createElement('div', ['empty-state-icon'], {}, '');
                    const text = this.createElement('div', ['empty-state-text'], {}, 'No tienes notificaciones');
                    empty.appendChild(icon);
                    empty.appendChild(text);
                    container.appendChild(empty);
                    return;
                }
                
                const fragment = document.createDocumentFragment();
                gameState.notifications.forEach(notif => {
                    const el = this.createNotificationElement(notif);
                    fragment.appendChild(el);
                });
                container.appendChild(fragment);
            },
            
            createNotificationElement(notif) {
                const div = this.createElement('div', 
                    ['notification-item', notif.unread ? 'unread' : ''].filter(Boolean)
                );
                div.onclick = () => markNotificationRead(notif.id);
                
                const icon = this.createElement('div', ['notification-icon'], {}, notif.icon);
                
                const content = this.createElement('div', ['notification-content']);
                const title = this.createElement('div', ['notification-title'], {}, notif.title);
                const text = this.createElement('div', ['notification-text'], {}, notif.text);
                const time = this.createElement('div', ['notification-time'], {}, notif.time);
                
                content.appendChild(title);
                content.appendChild(text);
                content.appendChild(time);
                
                div.appendChild(icon);
                div.appendChild(content);
                
                return div;
            }
        };

        // ==========================================
        // SECCIN 5: FUNCIONES DE JUEGO
        // ==========================================

        function checkDailyReset() {
            try {
                const now = new Date();
                const lastReset = gameState.user.lastResetDate ? 
                    new Date(gameState.user.lastResetDate) : null;
                
                const today5AM = new Date(now);
                today5AM.setHours(5, 0, 0, 0);
                
                if (now.getHours() < 5) {
                    today5AM.setDate(today5AM.getDate() - 1);
                }
                
                if (!lastReset || lastReset < today5AM) {
                    performDailyReset();
                }
            } catch (error) {
                console.error('Error en checkDailyReset:', error);
            }
        }

        function performDailyReset() {
            try {
                const now = new Date();
                gameState.user.lastResetDate = now.toISOString();
                
                const categories = Object.keys(gameState.quests);
                const allCompleted = categories.every(cat => 
                    gameState.quests[cat].every(q => q.completed)
                );
                
                if (allCompleted) {
                    gameState.user.currentStreak++;
                    gameState.user.longestStreak = Math.max(
                        gameState.user.longestStreak, 
                        gameState.user.currentStreak
                    );
                    gameState.stats.currentPerfectDayStreak++;
                    gameState.stats.perfectDays = Math.max(
                        gameState.stats.perfectDays,
                        gameState.stats.currentPerfectDayStreak
                    );
                    addNotification(' Racha Continuada', 
                        `Llevas ${gameState.user.currentStreak} das perfectos!`, '');
                } else {
                    if (gameState.user.currentStreak > 0) {
                        addNotification(' Racha Perdida', 
                            `Tu racha de ${gameState.user.currentStreak} das se ha reiniciado`, '');
                    }
                    gameState.user.currentStreak = 0;
                    gameState.stats.currentPerfectDayStreak = 0;
                }
                
                categories.forEach(category => {
                    gameState.quests[category].forEach(quest => {
                        if (quest.completed) {
                            quest.streak = (quest.streak || 0) + 1;
                        } else {
                            quest.streak = 0;
                        }
                        quest.completed = false;
                        quest.lastCompleted = null;
                    });
                });
                
                addNotification(' Nuevo Da', 
                    'Todas las misiones han sido reiniciadas. Buena suerte!', '');
                
                saveGame();
                SafeRenderer.renderQuests();
                updateStats();
                showToast('', 'Nuevo Da', 'Las misiones han sido reiniciadas');
                
            } catch (error) {
                console.error('Error en performDailyReset:', error);
            }
        }

        function toggleQuest(category, questId) {
            try {
                const quests = gameState.quests[category];
                if (!Array.isArray(quests)) {
                    console.error('Categora invlida:', category);
                    return;
                }
                
                const quest = quests.find(q => q.id === questId);
                if (!quest) {
                    console.error('Quest no encontrada:', questId);
                    return;
                }
                
                const wasCompleted = quest.completed;
                quest.completed = !wasCompleted;
                
                if (quest.completed) {
                    const now = new Date();
                    quest.lastCompleted = now.toISOString();
                    
                    const xpGain = Math.max(0, parseInt(quest.xp) || 0);
                    const goldGain = Math.max(0, parseInt(quest.gold) || 0);
                    
                    gameState.user.xp += xpGain;
                    gameState.user.gold += goldGain;
                    gameState.user.totalCompleted++;
                    gameState.user.totalXp += xpGain;
                    
                    if (gameState.stats.questsByCategory[category] !== undefined) {
                        gameState.stats.questsByCategory[category]++;
                    }
                    
                    AudioManager.play('complete');
                    damageBoss(xpGain);
                    
                    showToast('', 'Misin Completada!', 
                        `+${xpGain} XP  +${goldGain} Oro`);
                    
                    checkLevelUp();
                    checkAchievements();
                } else {
                    const xpLoss = Math.max(0, parseInt(quest.xp) || 0);
                    const goldLoss = Math.max(0, parseInt(quest.gold) || 0);
                    
                    gameState.user.xp = Math.max(0, gameState.user.xp - xpLoss);
                    gameState.user.gold = Math.max(0, gameState.user.gold - goldLoss);
                    gameState.user.totalCompleted = Math.max(0, gameState.user.totalCompleted - 1);
                    gameState.user.totalXp = Math.max(0, gameState.user.totalXp - xpLoss);
                    
                    if (gameState.stats.questsByCategory[category] > 0) {
                        gameState.stats.questsByCategory[category]--;
                    }
                }
                
                saveGame();
                renderAll();
                updateStats();
                
            } catch (error) {
                console.error('Error en toggleQuest:', error);
                const quest = gameState.quests[category]?.find(q => q.id === questId);
                if (quest) quest.completed = !quest.completed;
            }
        }

        function addQuest(e) {
            e.preventDefault();
            
            try {
                const nameInput = document.getElementById('quest-name');
                const catInput = document.getElementById('quest-category');
                
                const name = nameInput.value.trim();
                const category = catInput.value;
                
                if (!Validator.userName(name)) {
                    showToast('', 'Error', 'El nombre debe tener entre 1 y 100 caracteres');
                    return;
                }
                
                if (!['health', 'work', 'mind', 'social'].includes(category)) {
                    showToast('', 'Error', 'Categora invlida');
                    return;
                }
                
                const newQuest = {
                    id: IdGenerator.generateNumeric(),
                    title: name,
                    difficulty: selectedDifficulty,
                    completed: false,
                    streak: 0,
                    xp: selectedDifficulty * 15,
                    gold: selectedDifficulty * 5,
                    lastCompleted: null
                };
                
                const validation = Validator.quest({...newQuest, category});
                if (!validation.valid) {
                    showToast('', 'Error', validation.errors.join(', '));
                    return;
                }
                
                gameState.quests[category].push(newQuest);
                gameState.stats.totalQuestsCreated++;
                
                saveGame();
                SafeRenderer.renderQuests();
                closeModal();
                showToast('', 'Misin Creada', 'Nueva aventura comienza!');
                addNotification('Nueva Misin', `Has creado: ${name}`, '');
                
                nameInput.value = '';
                
            } catch (error) {
                console.error('Error creando quest:', error);
                showToast('', 'Error', 'No se pudo crear la misin');
            }
        }

        function addChatMessage(author, avatar, text, isSystem = false) {
            try {
                if (typeof author !== 'string' || typeof text !== 'string') {
                    console.error('Invalid chat message params');
                    return;
                }
                
                const safeText = text.substring(0, 200);
                const safeAuthor = author.substring(0, 20);
                const safeAvatar = avatar.substring(0, 2);
                
                const newMessage = {
                    id: IdGenerator.generate(),
                    author: safeAuthor,
                    avatar: safeAvatar,
                    text: safeText,
                    isSystem: !!isSystem,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                
                gameState.party.chat.push(newMessage);
                
                if (gameState.party.chat.length > 50) {
                    gameState.party.chat = gameState.party.chat.slice(-50);
                }
                
                SafeRenderer.renderChat();
                
            } catch (error) {
                console.error('Error en addChatMessage:', error);
            }
        }

        function addNotification(title, text, icon = '') {
            try {
                if (typeof title !== 'string' || typeof text !== 'string') return;
                
                const newNotif = {
                    id: IdGenerator.generate(),
                    title: title.substring(0, 50),
                    text: text.substring(0, 200),
                    icon: icon.substring(0, 2),
                    unread: true,
                    time: 'Ahora',
                    createdAt: Date.now()
                };
                
                gameState.notifications.unshift(newNotif);
                
                if (gameState.notifications.length > 50) {
                    gameState.notifications = gameState.notifications.slice(0, 50);
                }
                
                saveGame();
                SafeRenderer.renderNotifications();
                
            } catch (error) {
                console.error('Error en addNotification:', error);
            }
        }

        // ==========================================
        // SECCIN 6: FUNCIONES DE UI
        // ==========================================

        function renderAll() {
            SafeRenderer.renderQuests();
            renderParty();
            renderShop();
            renderMyRewards();
            SafeRenderer.renderAchievements();
            SafeRenderer.renderChat();
            SafeRenderer.renderNotifications();
            updateUI();
            updateCosmeticBadge();
        }

        function updateUI() {
            const nameEl = document.getElementById('char-name');
            const classEl = document.getElementById('char-class');
            const avatarEmoji = document.getElementById('avatar-emoji');
            
            if (nameEl) nameEl.textContent = gameState.user.name;
            if (classEl) classEl.textContent = `Nv. ${gameState.user.level} Aventurero`;
            if (avatarEmoji) avatarEmoji.textContent = gameState.user.avatar;
            
            updateAvatarDisplay('header-avatar', gameState.user.avatar);
            
            const hpBar = document.getElementById('hp-bar');
            const xpBar = document.getElementById('xp-bar');
            
            if (hpBar) {
                hpBar.style.width = Math.min(100, (gameState.user.hp / gameState.user.maxHp * 100)) + '%';
            }
            if (xpBar) {
                xpBar.style.width = Math.min(100, (gameState.user.xp / gameState.user.xpToNext * 100)) + '%';
            }
            
            const totalCompleted = document.getElementById('total-completed');
            const maxStreak = document.getElementById('max-streak');
            const currentLevel = document.getElementById('current-level');
            const totalXp = document.getElementById('total-xp');
            
            if (totalCompleted) totalCompleted.textContent = gameState.user.totalCompleted;
            if (maxStreak) maxStreak.textContent = gameState.user.longestStreak;
            if (currentLevel) currentLevel.textContent = gameState.user.level;
            if (totalXp) totalXp.textContent = gameState.user.totalXp;
            
            document.getElementById('header-xp').textContent = gameState.user.xp;
            document.getElementById('header-gold').textContent = gameState.user.gold;
            document.getElementById('header-streak').textContent = gameState.user.currentStreak;
        }

        function updateAvatarDisplay(elementId, avatar) {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            const color = colorPalettes[gameState.user.avatarColor] || colorPalettes[0];
            container.style.background = color.gradient;
            
            container.innerHTML = '<div class="level-ring"></div>';
            
            if (gameState.user.equippedCosmetics.aura) {
                const aura = document.createElement('div');
                aura.className = `aura-${getAuraClass(gameState.user.equippedCosmetics.aura)}`;
                container.appendChild(aura);
            }
            
            const span = document.createElement('span');
            span.id = elementId === 'header-avatar' ? 'avatar-emoji' : 'preview-emoji';
            span.textContent = avatar;
            container.appendChild(span);
            
            if (gameState.user.equippedCosmetics.hat) {
                const hat = document.createElement('div');
                hat.className = 'avatar-hat';
                hat.textContent = getCosmeticIcon(gameState.user.equippedCosmetics.hat);
                container.appendChild(hat);
            }
            
            if (gameState.user.equippedCosmetics.glasses) {
                const glasses = document.createElement('div');
                glasses.className = 'avatar-glasses';
                glasses.textContent = getCosmeticIcon(gameState.user.equippedCosmetics.glasses);
                container.appendChild(glasses);
            }
            
            if (gameState.user.equippedCosmetics.cape) {
                const cape = document.createElement('div');
                cape.className = 'avatar-cape';
                cape.textContent = getCosmeticIcon(gameState.user.equippedCosmetics.cape);
                container.appendChild(cape);
            }
        }

        function switchTab(tabName, subSection = null) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            const targetSection = subSection ? document.getElementById(`${subSection}-section`) : document.getElementById(`${tabName}-section`);
            if (targetSection) targetSection.classList.add('active');
            
            const tabBtn = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (tabBtn) tabBtn.classList.add('active');
            
            const navBtn = document.querySelector(`.nav-item[data-nav="${tabName}"]`);
            if (navBtn) navBtn.classList.add('active');
            
            if (tabName === 'avatar') {
                renderAvatarOptions();
                renderColorOptions();
                renderInventory();
                renderEquippedItems();
            } else if (tabName === 'shop') {
                renderShop();
            } else if (tabName === 'party') {
                renderParty();
                SafeRenderer.renderChat();
            } else if (tabName === 'profile' && subSection === 'achievements') {
                SafeRenderer.renderAchievements();
            } else if (tabName === 'profile' && subSection === 'stats') {
                updateStats();
            }
        }

        function renderParty() {
            const container = document.getElementById('party-members');
            if (!container) return;
            
            container.innerHTML = '';
            
            gameState.party.members.forEach(member => {
                const div = document.createElement('div');
                div.className = 'party-member';
                
                div.innerHTML = `
                    <div class="party-member-avatar">
                        ${member.avatar}
                        <div class="party-member-status status-${member.status}"></div>
                    </div>
                    <div class="party-member-info">
                        <div class="party-member-name">
                            ${member.name} ${member.isYou ? '(T)' : ''} ${member.isLeader ? '' : ''}
                        </div>
                        <div class="party-member-level">Nv. ${member.level} Aventurero</div>
                    </div>
                    <div class="party-member-xp">+${member.level * 10} XP/h</div>
                `;
                
                container.appendChild(div);
            });
            
            const bossHp = document.getElementById('boss-hp');
            const bossHpText = document.getElementById('boss-hp-text');
            if (bossHp) {
                const percent = (gameState.party.boss.hp / gameState.party.boss.maxHp) * 100;
                bossHp.style.width = `${percent}%`;
            }
            if (bossHpText) {
                bossHpText.textContent = `${gameState.party.boss.hp}/${gameState.party.boss.maxHp} HP`;
            }
        }

        function renderShop() {
            const container = document.getElementById('shop-grid');
            if (!container) return;
            
            container.innerHTML = '';
            
            const filtered = currentShopFilter === 'all' 
                ? gameState.cosmetics 
                : gameState.cosmetics.filter(c => c.type === currentShopFilter);
            
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = `shop-item ${item.purchased ? 'purchased' : ''}`;
                
                div.innerHTML = `
                    <div class="shop-item-rarity rarity-${item.rarity}">${item.rarity}</div>
                    <div class="shop-item-icon">${item.icon}</div>
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-type">${item.type}</div>
                    <div class="shop-item-price">
                        <span></span> ${item.price}
                    </div>
                    <button class="shop-item-btn ${item.purchased ? 'equip' : 'buy'}" 
                            onclick="${item.purchased ? `equipCosmetic('${item.id}')` : `buyCosmetic('${item.id}')`}"
                            ${!item.purchased && gameState.user.gold < item.price ? 'disabled' : ''}>
                        ${item.purchased ? (item.equipped ? 'Equipado' : 'Equipar') : 'Comprar'}
                    </button>
                `;
                
                container.appendChild(div);
            });
        }

        function renderMyRewards() {
            const container = document.getElementById('inventory-grid');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (gameState.myRewards.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-state-icon"></div><div class="empty-state-text">No tienes recompensas</div></div>';
                return;
            }
            
            gameState.myRewards.forEach(reward => {
                const div = document.createElement('div');
                div.className = 'inventory-item';
                div.innerHTML = reward.icon;
                div.onclick = () => useReward(reward.id);
                container.appendChild(div);
            });
        }

        function renderAvatarOptions() {
            const container = document.getElementById('avatar-options');
            if (!container) return;
            
            container.innerHTML = '';
            
            avatarOptions.forEach(avatar => {
                const div = document.createElement('div');
                div.className = `avatar-option ${avatar === tempAvatar ? 'selected' : ''}`;
                div.textContent = avatar;
                div.onclick = () => selectAvatar(avatar);
                container.appendChild(div);
            });
        }

        function renderColorOptions() {
            const container = document.getElementById('color-options');
            if (!container) return;
            
            container.innerHTML = '';
            
            colorPalettes.forEach((color, index) => {
                const div = document.createElement('div');
                div.className = `color-option ${index === gameState.user.avatarColor ? 'selected' : ''}`;
                div.style.background = color.gradient;
                div.onclick = () => selectColor(index);
                container.appendChild(div);
            });
        }

        function renderInventory() {
            const container = document.getElementById('inventory-grid');
            if (!container) return;
            
            container.innerHTML = '';
            
            const purchased = gameState.cosmetics.filter(c => c.purchased);
            
            if (purchased.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-state-icon"></div><div class="empty-state-text">No tienes cosmticos</div></div>';
                return;
            }
            
            purchased.forEach(item => {
                const div = document.createElement('div');
                div.className = `inventory-item ${item.equipped ? 'equipped' : ''}`;
                div.innerHTML = `
                    ${item.icon}
                    <div class="inventory-item-slot">${item.type}</div>
                `;
                div.onclick = () => equipCosmetic(item.id);
                container.appendChild(div);
            });
        }

        function renderEquippedItems() {
            const container = document.getElementById('equipped-items');
            if (!container) return;
            
            container.innerHTML = '';
            
            const slots = [
                { key: 'hat', label: 'Sombrero' },
                { key: 'glasses', label: 'Gafas' },
                { key: 'cape', label: 'Capa' },
                { key: 'aura', label: 'Aura' },
                { key: 'accessory', label: 'Accesorio' }
            ];
            
            slots.forEach(slot => {
                const equipped = gameState.cosmetics.find(c => c.id === gameState.user.equippedCosmetics[slot.key]);
                
                const div = document.createElement('div');
                div.className = 'equipped-slot';
                div.innerHTML = `
                    <div class="equipped-slot-label">${slot.label}</div>
                    <div class="equipped-slot-item">${equipped ? equipped.icon : '-'}</div>
                `;
                
                container.appendChild(div);
            });
        }

        function updateStats() {
            document.getElementById('stat-quests').textContent = gameState.user.totalCompleted;
            document.getElementById('stat-streak').textContent = gameState.user.currentStreak;
            document.getElementById('stat-perfect').textContent = gameState.stats.perfectDays;
            document.getElementById('stat-bosses').textContent = gameState.stats.bossesDefeated;
            
            const unlockedCount = gameState.achievements.filter(a => a.unlocked).length;
            document.getElementById('achievements-count').textContent = `${unlockedCount} de ${gameState.achievements.length} logros`;
        }

        function updateCosmeticBadge() {
            const badge = document.getElementById('cosmetic-badge');
            if (!badge) return;
            
            const newItems = gameState.cosmetics.filter(c => c.purchased && !c.seen).length;
            badge.textContent = newItems;
            badge.style.display = newItems > 0 ? 'flex' : 'none';
        }

        // ==========================================
        // SECCIN 7: ACCIONES DEL USUARIO
        // ==========================================

        function selectDifficulty(diff) {
            selectedDifficulty = diff;
            document.querySelectorAll('#quest-modal .difficulty-option').forEach((el, i) => {
                el.classList.toggle('selected', i + 1 === diff);
            });
        }

        function selectEditDifficulty(diff) {
            editDifficulty = diff;
            document.querySelectorAll('#edit-quest-modal .difficulty-option').forEach((el, i) => {
                el.classList.toggle('selected', i + 1 === diff);
            });
        }

        function selectAvatar(avatar) {
            tempAvatar = avatar;
            gameState.user.avatar = avatar;
            renderAvatarOptions();
            updateAvatarDisplay('avatar-preview', avatar);
            updateAvatarDisplay('header-avatar', avatar);
            saveGame();
        }

        function selectColor(index) {
            gameState.user.avatarColor = index;
            renderColorOptions();
            updateAvatarDisplay('avatar-preview', gameState.user.avatar);
            updateAvatarDisplay('header-avatar', gameState.user.avatar);
            saveGame();
        }

        function buyCosmetic(id) {
            const item = gameState.cosmetics.find(c => c.id === id);
            if (!item || item.purchased) return;
            
            if (gameState.user.gold < item.price) {
                showToast('', 'Sin fondos', 'No tienes suficiente oro');
                return;
            }
            
            gameState.user.gold -= item.price;
            item.purchased = true;
            item.purchaseDate = new Date().toISOString();
            gameState.stats.cosmeticsBought++;
            gameState.stats.shopBuys++;
            
            saveGame();
            renderShop();
            updateUI();
            showToast('', 'Comprado!', `Has adquirido: ${item.name}`);
            addNotification('Nueva Compra', `Has comprado: ${item.name}`, '');
        }

        function equipCosmetic(id) {
            const item = gameState.cosmetics.find(c => c.id === id);
            if (!item || !item.purchased) return;
            
            const currentEquipped = gameState.cosmetics.find(c => 
                c.type === item.type && c.equipped
            );
            
            if (currentEquipped) {
                currentEquipped.equipped = false;
            }
            
            if (gameState.user.equippedCosmetics[item.type] === id) {
                gameState.user.equippedCosmetics[item.type] = null;
                item.equipped = false;
            } else {
                gameState.user.equippedCosmetics[item.type] = id;
                item.equipped = true;
            }
            
            saveGame();
            renderShop();
            renderInventory();
            renderEquippedItems();
            updateAvatarDisplay('header-avatar', gameState.user.avatar);
            updateAvatarDisplay('avatar-preview', gameState.user.avatar);
        }

        function getCosmeticIcon(id) {
            const item = gameState.cosmetics.find(c => c.id === id);
            return item ? item.icon : '';
        }

        function getAuraClass(id) {
            if (id.includes('magic')) return 'magic';
            if (id.includes('fire')) return 'fire';
            if (id.includes('ice')) return 'ice';
            if (id.includes('gold')) return 'gold';
            if (id.includes('shadow')) return 'shadow';
            return 'magic';
        }

        function damageBoss(amount) {
            gameState.party.boss.hp = Math.max(0, gameState.party.boss.hp - amount);
            
            if (gameState.party.boss.hp === 0) {
                defeatBoss();
            }
            
            const bossHp = document.getElementById('boss-hp');
            const bossHpText = document.getElementById('boss-hp-text');
            if (bossHp) {
                const percent = (gameState.party.boss.hp / gameState.party.boss.maxHp) * 100;
                bossHp.style.width = `${percent}%`;
            }
            if (bossHpText) {
                bossHpText.textContent = `${gameState.party.boss.hp}/${gameState.party.boss.maxHp} HP`;
            }
            
            saveGame();
        }

        function defeatBoss() {
            gameState.stats.bossesDefeated++;
            gameState.user.gold += 100;
            gameState.user.xp += 500;
            
            addChatMessage('Sistema', '', `${gameState.user.name} ha derrotado al jefe!`, true);
            addNotification('Jefe Derrotado!', 'Has derrotado a la Procrastinacin Suprema', '');
            
            gameState.party.boss.hp = gameState.party.boss.maxHp;
            gameState.party.boss.level++;
            
            checkLevelUp();
            saveGame();
        }

        function checkLevelUp() {
            while (gameState.user.xp >= gameState.user.xpToNext) {
                gameState.user.xp -= gameState.user.xpToNext;
                gameState.user.level++;
                gameState.user.xpToNext = Math.floor(gameState.user.xpToNext * 1.5);
                gameState.user.maxHp += 20;
                gameState.user.hp = gameState.user.maxHp;
                
                AudioManager.play('levelup');
                showLevelUpModal(gameState.user.level);
                addNotification('Subiste de Nivel!', `Has alcanzado el nivel ${gameState.user.level}`, '');
            }
        }

        function checkAchievements() {
            let newUnlocks = 0;
            
            gameState.achievements.forEach(ach => {
                if (!ach.unlocked && ach.condition(gameState)) {
                    ach.unlocked = true;
                    ach.unlockedAt = new Date().toISOString();
                    newUnlocks++;
                    
                    showToast('', 'Logro Desbloqueado!', `${ach.name}: ${ach.desc}`);
                    addNotification('Nuevo Logro', `Desbloqueado: ${ach.name}`, '');
                }
            });
            
            if (newUnlocks > 0) {
                saveGame();
                updateStats();
            }
        }

        function checkFirstTime() {
            if (!gameState.user.joinDate) {
                isFirstTime = true;
                gameState.user.joinDate = new Date().toISOString();
                addNotification('Bienvenido!', 'Comienza tu aventura completando misiones', '');
                saveGame();
            }
        }

        function checkReminders() {
            const now = new Date();
            const hour = now.getHours();
            
            if (hour === 9 && gameState.user.settings.notifications) {
                const incomplete = Object.values(gameState.quests)
                    .flat()
                    .filter(q => !q.completed).length;
                
                if (incomplete > 0) {
                    addNotification('Buenos das', `Tienes ${incomplete} misiones pendientes`, '');
                }
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            addChatMessage(gameState.user.name, gameState.user.avatar, text);
            input.value = '';
            saveGame();
            
            setTimeout(() => {
                const responses = [
                    'Genial! ',
                    'Vamos! ',
                    'Increble! ',
                    'Sigue as! ',
                    'Eres un crack! '
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addChatMessage('Mara', '', randomResponse);
            }, 2000);
        }

        function copyPartyCode() {
            navigator.clipboard.writeText(gameState.party.code).then(() => {
                showToast('', 'Copiado', 'Cdigo copiado al portapapeles');
            });
        }

        function sharePartyCode() {
            if (navigator.share) {
                navigator.share({
                    title: 'nete a mi party en LifeQuest',
                    text: `nete a mi party con el cdigo: ${gameState.party.code}`,
                    url: window.location.href
                });
            } else {
                copyPartyCode();
            }
        }

        function filterShop(type) {
            currentShopFilter = type;
            document.querySelectorAll('.shop-filter').forEach(f => f.classList.remove('active'));
            event.target.classList.add('active');
            renderShop();
        }

        function useReward(id) {
            const reward = gameState.myRewards.find(r => r.id === id);
            if (!reward) return;
            
            if (reward.effect === 'hp') {
                gameState.user.hp = Math.min(gameState.user.maxHp, gameState.user.hp + reward.value);
            } else if (reward.effect === 'xp') {
                gameState.user.xp += reward.value;
                checkLevelUp();
            }
            
            gameState.myRewards = gameState.myRewards.filter(r => r.id !== id);
            saveGame();
            renderMyRewards();
            updateUI();
            showToast('', 'Usado', `Has usado: ${reward.name}`);
        }

        // ==========================================
        // SECCIN 8: MODALES Y DILOGOS
        // ==========================================

        function openQuestModal() {
            document.getElementById('quest-modal').classList.add('active');
            document.getElementById('quest-name').focus();
        }

        function closeModal() {
            document.getElementById('quest-modal').classList.remove('active');
            document.getElementById('quest-name').value = '';
            selectDifficulty(2);
        }

        function openQuestEditModal(category, questId) {
            const quest = gameState.quests[category].find(q => q.id === questId);
            if (!quest) return;
            
            currentEditingQuest = { category, questId };
            document.getElementById('edit-quest-name').value = quest.title;
            document.getElementById('edit-quest-category').value = category;
            selectEditDifficulty(quest.difficulty);
            document.getElementById('edit-quest-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-quest-modal').classList.remove('active');
            currentEditingQuest = null;
        }

        function saveQuestEdit(e) {
            e.preventDefault();
            
            if (!currentEditingQuest) return;
            
            const name = document.getElementById('edit-quest-name').value.trim();
            const newCategory = document.getElementById('edit-quest-category').value;
            
            if (!Validator.userName(name)) {
                showToast('', 'Error', 'Nombre invlido');
                return;
            }
            
            const { category, questId } = currentEditingQuest;
            const quest = gameState.quests[category].find(q => q.id === questId);
            
            if (!quest) return;
            
            quest.title = name;
            quest.difficulty = editDifficulty;
            quest.xp = editDifficulty * 15;
            quest.gold = editDifficulty * 5;
            
            if (category !== newCategory) {
                gameState.quests[category] = gameState.quests[category].filter(q => q.id !== questId);
                quest.category = newCategory;
                gameState.quests[newCategory].push(quest);
            }
            
            saveGame();
            SafeRenderer.renderQuests();
            closeEditModal();
            showToast('', 'Actualizado', 'Misin actualizada correctamente');
        }

        function confirmDeleteQuest(category, questId) {
            const quest = gameState.quests[category].find(q => q.id === questId);
            if (!quest) return;
            
            showConfirmDialog(
                'Eliminar misin?',
                `Ests seguro de que quieres eliminar "${quest.title}"?`,
                '',
                () => {
                    gameState.quests[category] = gameState.quests[category].filter(q => q.id !== questId);
                    saveGame();
                    SafeRenderer.renderQuests();
                    showToast('', 'Eliminado', 'Misin eliminada');
                }
            );
        }

        function openProfile() {
            switchTab('profile');
        }

        function openProfileEdit() {
            document.getElementById('profile-name-input').value = gameState.user.name;
            document.getElementById('profile-email-input').value = '';
            document.getElementById('profile-modal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        function saveProfile(e) {
            e.preventDefault();
            
            const name = document.getElementById('profile-name-input').value.trim();
            const email = document.getElementById('profile-email-input').value.trim();
            
            if (!Validator.userName(name)) {
                showToast('', 'Error', 'Nombre invlido');
                return;
            }
            
            gameState.user.name = name;
            gameState.stats.profileEdits++;
            
            saveGame();
            updateUI();
            closeProfileModal();
            showToast('', 'Perfil Actualizado', 'Tus cambios han sido guardados');
        }

        function openAvatarSection() {
            switchTab('avatar');
        }

        function openCosmeticShop() {
            switchTab('shop');
        }

        function showConfirmDialog(title, text, icon, callback) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-text').textContent = text;
            document.getElementById('confirm-icon').textContent = icon;
            confirmCallback = callback;
            document.getElementById('confirm-dialog').classList.add('active');
        }

        function closeConfirmDialog() {
            document.getElementById('confirm-dialog').classList.remove('active');
            confirmCallback = null;
        }

        function executeConfirmAction() {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            closeConfirmDialog();
        }

        function showLevelUpModal(level) {
            document.getElementById('new-level').textContent = level;
            document.getElementById('level-up-modal').classList.add('active');
        }

        function closeLevelUpModal() {
            document.getElementById('level-up-modal').classList.remove('active');
        }

        function showToast(icon, title, text) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-icon').textContent = icon;
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-text').textContent = text;
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function toggleNotifications() {
            document.getElementById('notification-panel').classList.toggle('active');
            if (document.getElementById('notification-panel').classList.contains('active')) {
                gameState.notifications.forEach(n => n.unread = false);
                saveGame();
                SafeRenderer.renderNotifications();
            }
        }

        function markNotificationRead(id) {
            const notif = gameState.notifications.find(n => n.id === id);
            if (notif) {
                notif.unread = false;
                saveGame();
                SafeRenderer.renderNotifications();
            }
        }

        function exportData() {
            try {
                const data = {
                    ...gameState,
                    _export: {
                        date: new Date().toISOString(),
                        appVersion: '2.0.0',
                        platform: navigator.userAgent
                    }
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                
                const safeName = gameState.user.name.replace(/[^a-zA-Z0-9-_]/g, '_');
                link.download = `lifequest-backup-${safeName}-${Date.now()}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('', 'Datos Exportados', 'Backup descargado correctamente');
                
            } catch (error) {
                console.error('Error exportando:', error);
                showToast('', 'Error', 'No se pudieron exportar los datos');
            }
        }

        function confirmResetData() {
            const backup = JSON.parse(JSON.stringify(gameState));
            
            showConfirmDialog(
                'Reiniciar todo?',
                'Ests seguro de que quieres borrar TODOS tus datos? Esta accin no se puede deshacer.',
                '',
                () => {
                    setTimeout(() => {
                        showConfirmDialog(
                            'De verdad?',
                            `Esta es tu ltima oportunidad. Tienes ${gameState.user.totalCompleted} misiones completadas. Deseas continuar?`,
                            '',
                            () => {
                                try {
                                    sessionStorage.setItem('lifequest_emergency_backup', 
                                        JSON.stringify(backup));
                                    
                                    StorageManager.clear();
                                    location.reload();
                                } catch (error) {
                                    console.error('Error reseteando:', error);
                                    showToast('', 'Error', 'No se pudo reiniciar');
                                }
                            }
                        );
                    }, 300);
                }
            );
        }

        // Inicializacin
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
